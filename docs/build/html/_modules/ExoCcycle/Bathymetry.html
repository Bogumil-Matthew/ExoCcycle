<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ExoCcycle.Bathymetry &#8212; ExoCcycle  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ExoCcycle.Bathymetry</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Sep  6 15:20:00 2024</span>

<span class="sd">@author: Matthew Bogumil</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#######################################################################</span>
<span class="c1">############################### Imports ###############################</span>
<span class="c1">#######################################################################</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ExoCcycle</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span> <span class="c1"># type: ignore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ExoCcycle</span><span class="w"> </span><span class="kn">import</span> <span class="n">plotHelper</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span> <span class="c1"># used for progress bar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">NearestNDInterpolator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span> <span class="c1"># type: ignore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>

<span class="c1">#######################################################################</span>
<span class="c1">#################### ExoCcycle Create Bathymetries ####################</span>
<span class="c1">#######################################################################   </span>
<div class="viewcode-block" id="BathyMeasured">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyMeasured">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BathyMeasured</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measured topography/bathymetry helper for Venus, Earth, Mars, and Moon.</span>

<span class="sd">    This class downloads publicly available planetary topography datasets,</span>
<span class="sd">    reprojects / converts them to NetCDF when needed, resamples to a chosen</span>
<span class="sd">    angular resolution, and derives a bathymetry model by flooding the</span>
<span class="sd">    topography to satisfy either an ocean-area or water-volume constraint.</span>
<span class="sd">    It also exports bathymetry grids and related carbon-cycle distributions</span>
<span class="sd">    in NetCDF format for downstream use in ExoCcycle.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Downloaded sources (indicative):</span>
<span class="sd">        * Venus (Magellan): USGS Planetary Data (GeoTIFF → NetCDF) - https://astrogeology.usgs.gov/search/map/venus_magellan_global_c3_mdir_colorized_topographic_mosaic_6600m</span>
<span class="sd">        * Venus (PDS IMG): PDS Geosciences Node (IMG → NetCDF) - https://pds-geosciences.wustl.edu/mgn/mgn-v-rss-5-gravity-l2-v1/mg_5201/images/topogrd.img</span>
<span class="sd">        * Earth: ETOPO1 (NetCDF/GRD) - https://www.ngdc.noaa.gov/mgg/global/relief/ETOPO1/data/ice_surface/cell_registered/netcdf/</span>
<span class="sd">        * Mars: MOLA (NetCDF) - https://github.com/andrebelem/PlanetaryMaps/raw/v1.0/mola32.nc</span>
<span class="sd">        * Moon: Planetary Geodesy Data Archive (PGDA) - https://pgda.gsfc.nasa.gov/data/LOLA_PA/LDEM64_PA_pixel_202405.grd</span>
<span class="sd">    - Several steps invoke external CLI tools (GMT, GDAL, wget). Ensure they</span>
<span class="sd">      are installed and available on ``PATH``.</span>
<span class="sd">    - Longitudes are normalized to ``[-180, 180]`` and latitudes to</span>
<span class="sd">      ``[-90, 90]``; cell registration is preserved during resampling.</span>

<span class="sd">    Attributes (set after initialization or workflow steps)</span>
<span class="sd">    -------------------------------------------------------</span>
<span class="sd">    model : str</span>
<span class="sd">        One of ``{&quot;Venus2&quot;,&quot;Venus&quot;,&quot;Earth&quot;,&quot;Mars&quot;,&quot;Moon&quot;}``.</span>
<span class="sd">    fidName : str</span>
<span class="sd">        Canonical filename of the raw source grid for the selected body.</span>
<span class="sd">    variables : dict</span>
<span class="sd">        Mapping of variable names present in the source NetCDF/GRD/IMG</span>
<span class="sd">        (e.g., ``{&quot;lat&quot;:&quot;lat&quot;, &quot;lon&quot;:&quot;lon&quot;, &quot;elev&quot;:&quot;z&quot;}``).</span>
<span class="sd">    initiallykm : bool</span>
<span class="sd">        Whether the input elevation is given in kilometers (converted to meters).</span>
<span class="sd">    radiuskm : float</span>
<span class="sd">        Planetary radius (km) used for area computations.</span>
<span class="sd">    highlatP : float</span>
<span class="sd">        Decimal fraction of ocean area designated as “high-latitude box”</span>
<span class="sd">        for LOSCAR-style parameterization.</span>
<span class="sd">    resolution : float</span>
<span class="sd">        Target angular resolution (degrees) set by :meth:`readTopo`.</span>
<span class="sd">    data_dir : str</span>
<span class="sd">        Root directory used to store inputs/outputs.</span>
<span class="sd">    lon, lat : ndarray</span>
<span class="sd">        2-D cell-registered longitudes/latitudes (deg) for resampled grids.</span>
<span class="sd">    elev : ndarray</span>
<span class="sd">        2-D topography (meters; positive above sea level).</span>
<span class="sd">    bathymetry : ndarray</span>
<span class="sd">        2-D seafloor depth (meters; positive), land masked as NaN.</span>
<span class="sd">    areaWeights : ndarray</span>
<span class="sd">        2-D area weight per cell (m²) for the selected radius/resolution.</span>
<span class="sd">    AOC, VOC : float</span>
<span class="sd">        Ocean surface area (m²) and ocean volume (m³) of derived bathymetry.</span>
<span class="sd">    highlatA : float</span>
<span class="sd">        High-latitude ocean area (m²) implied by ``highlatP``.</span>
<span class="sd">    highlatlat : float</span>
<span class="sd">        Latitude cutoff (deg) delimiting the high-latitude region.</span>
<span class="sd">    bathymetryAreaDist, bathymetryAreaDist_wHighlat : ndarray</span>
<span class="sd">        Kernelized/semi-binned bathymetry distributions (global w/o and with</span>
<span class="sd">        high-latitude contribution).</span>
<span class="sd">    binEdges : ndarray</span>
<span class="sd">        Bin edges (km) used for bathymetry distributions.</span>
<span class="sd">    nc, bathync : netCDF4.Dataset</span>
<span class="sd">        Open handles to resampled topography and saved bathymetry NetCDFs</span>
<span class="sd">        (when used).</span>
<span class="sd">    &quot;&quot;&quot;</span>    
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Measured topography (~bathymetry) Venus/Mars/Moon/present-day Earth.</span>

<span class="sd">    getTopo is a method to download different topography models.</span>
<span class="sd">        getTopo(self, body = {&#39;Mars&#39;:&#39;True&#39;, &#39;Venus&#39;:&#39;False&#39;, &#39;Moon&#39;:&#39;False&#39;, &#39;Earth&#39;:&#39;False&#39;}):</span>


<span class="sd">    </span>
<span class="sd">    readTopo is a method to read in a downloaded topography models. They are interpolated and</span>
<span class="sd">    saved to the same input directory. Topography model was already saved with a chosen resolution</span>
<span class="sd">    then this model is read instead.</span>
<span class="sd">        readTopo(self, data_dir, new_resolution = 1, verbose=True):</span>
<span class="sd">    </span>
<span class="sd">    setSeaLevel is a method to </span>
<span class="sd">        setSeaLevel(self, basinVolume = {&quot;on&quot;:True, &#39;uncompactedVol&#39;:None}, oceanArea = {&quot;on&quot;:True, &quot;area&quot;:0.7}, isostaticCompensation = {&quot;on&quot;:False}):</span>
<span class="sd">        1. Might be useful for flexural Isostasy:</span>
<span class="sd">            https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2017JB014571</span>
<span class="sd">            https://pages.uoregon.edu/rdorsey/BasinAnalysis/AngevineEtal1990/Chapt%205%20Flexure.pdf</span>
<span class="sd">        2. Might be useful for the Isostasy</span>
<span class="sd">            https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2017GL073334</span>

<span class="sd">    saveBathymetry is a method used to save bathymetry created after running setSeaLevel</span>
<span class="sd">        saveBathymetry(self, filePath):</span>

<span class="sd">    loadBathymetry is a method used to load bathymetry created after running setSeaLevel() and saveBathymetry()</span>
<span class="sd">        loadBathymetry(self, filePath):</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a planetary dataset preset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        body : {&quot;Venus2&quot;,&quot;Venus&quot;,&quot;Earth&quot;,&quot;Mars&quot;,&quot;Moon&quot;} or None</span>
<span class="sd">            Planetary body/preset to configure. Sets source filenames,</span>
<span class="sd">            variable names, unit flags, planet radius, and default</span>
<span class="sd">            high-latitude fraction. If ``None`` or unrecognized, prints a</span>
<span class="sd">            helpful message and leaves the object unconfigured.</span>

<span class="sd">        Side Effects</span>
<span class="sd">        ------------</span>
<span class="sd">        Sets attributes: ``model``, ``fidName``, ``variables``, ``initiallykm``,</span>
<span class="sd">        ``radiuskm``, ``highlatP`` based on selection.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - ``&quot;Venus2&quot;`` refers to the Magellan C3-MDIR colorized topographic</span>
<span class="sd">          mosaic (USGS; GeoTIFF).</span>
<span class="sd">        - ``&quot;Venus&quot;`` refers to the PDS ``topogrd.img`` product.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">body</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No body was chosen. Define input body as &quot;Venus&quot; | &quot;Earth&quot; | &quot;Mars&quot; | &quot;Moon&quot;&#39;</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">body</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;venus2&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;Venus2&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.nc&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;elev&quot;</span><span class="p">:[</span><span class="s2">&quot;Band1&quot;</span><span class="p">,</span><span class="s2">&quot;Band2&quot;</span><span class="p">,</span><span class="s2">&quot;Band3&quot;</span><span class="p">]};</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initiallykm</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span> <span class="o">=</span> <span class="mf">6051.8</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span> <span class="o">=</span> <span class="mf">.10</span><span class="p">;</span> <span class="c1"># this is the hb[10] value from LOSCAR.</span>
            <span class="k">elif</span> <span class="n">body</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;venus&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;Venus&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;topogrd.nc&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;elev&quot;</span><span class="p">:</span><span class="s2">&quot;elev&quot;</span><span class="p">};</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initiallykm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span> <span class="o">=</span> <span class="mf">6051.8</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span> <span class="o">=</span> <span class="mf">.10</span><span class="p">;</span> <span class="c1"># this is the hb[10] value from LOSCAR.</span>
            <span class="k">elif</span> <span class="n">body</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;earth&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;Earth&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;ETOPO1_Ice_c_gdal.nc&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;elev&quot;</span><span class="p">:</span><span class="s2">&quot;z&quot;</span><span class="p">};</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initiallykm</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span> <span class="o">=</span> <span class="mf">6371.0</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span> <span class="o">=</span> <span class="mf">.10</span><span class="p">;</span> <span class="c1"># this is the hb[10] value from LOSCAR.</span>
            <span class="k">elif</span> <span class="n">body</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mars&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;Mars&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;mola32.nc&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;elev&quot;</span><span class="p">:</span><span class="s2">&quot;alt&quot;</span><span class="p">};</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initiallykm</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span> <span class="o">=</span> <span class="mf">3389.5</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span> <span class="o">=</span> <span class="mf">.10</span><span class="p">;</span> <span class="c1"># this is the hb[10] value from LOSCAR.</span>
            <span class="k">elif</span> <span class="n">body</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;moon&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;Moon&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;LDEM64_PA_pixel_202405.nc&quot;</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;elev&quot;</span><span class="p">:</span><span class="s2">&quot;z&quot;</span><span class="p">};</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initiallykm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span> <span class="o">=</span> <span class="mf">1737.4</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span> <span class="o">=</span> <span class="mf">.10</span><span class="p">;</span> <span class="c1"># this is the hb[10] value from LOSCAR.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chosen a implemented body. Define input body as &quot;Venus&quot; | &quot;Earth&quot; | &quot;Mars&quot; | &quot;Moon&quot;&#39;</span><span class="p">);</span>

<div class="viewcode-block" id="BathyMeasured.getTopo">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyMeasured.getTopo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getTopo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download (if needed) and convert the selected body&#39;s topography.</span>

<span class="sd">        The method creates a structured directory tree under</span>
<span class="sd">        ``{data_dir}/topographies/{Body}``, pulls remote datasets using</span>
<span class="sd">        ``wget``, converts GRD/IMG/GeoTIFF to NetCDF (via GDAL/GMT), and</span>
<span class="sd">        optionally produces a quicklook PostScript using GMT.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dir : str</span>
<span class="sd">            Root directory for data storage. Subfolders will be created per body.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, emits GMT preview commands to generate simple plots.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Creates</span>
<span class="sd">        -------</span>
<span class="sd">        {data_dir}/topographies/{Body}/&lt;source&gt;.nc</span>
<span class="sd">            NetCDF representation of the raw/global topography.</span>
<span class="sd">        {data_dir}/topographies/{Body}/{Body}.ps</span>
<span class="sd">            (Optional) Quicklook GMT plot when ``verbose=True``.</span>

<span class="sd">        Dependencies</span>
<span class="sd">        ------------</span>
<span class="sd">        Requires external tools: ``wget``, ``gdalwarp``, ``gdal_translate``,</span>
<span class="sd">        and/or ``gmt`` depending on the source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make directory for storing topography model</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_file_structure</span><span class="p">([</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/topographies&quot;</span><span class="p">,</span>
                                     <span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/topographies/Earth&quot;</span><span class="p">,</span>
                                     <span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/topographies/Venus&quot;</span><span class="p">,</span>
                                     <span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/topographies/Mars&quot;</span><span class="p">,</span>
                                     <span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/topographies/Moon&quot;</span><span class="p">],</span>
                                     <span class="n">root</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Download model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Venus2&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;wget -O </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.tif https://planetarymaps.usgs.gov/mosaic/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m_reprojected.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;export PROJ_IGNORE_CELESTIAL_BODY=YES &amp;&amp;</span><span class="se">\</span>
<span class="s2">                        gdalwarp -t_srs EPSG:4326 </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.tif </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m_reprojected.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gdal_translate -of NetCDF </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m_reprojected.tif </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdimage </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/Venus_Magellan_C3-MDIR_ClrTopo_Global_Mosaic_6600m.nc -JN0/5i -Crelief -P -K -Vq&gt; </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">.ps&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Venus&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/topogrd.img&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;wget -O </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/topogrd.img https://pds-geosciences.wustl.edu/mgn/mgn-v-rss-5-gravity-l2-v1/mg_5201/images/topogrd.img&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/topogrd.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="c1"># Write netCDF file</span>
                <span class="c1">## Read .img</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/topogrd.img&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">);</span>
                <span class="n">elevmodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">);</span>
                <span class="n">lonmodel</span><span class="p">,</span> <span class="n">latmodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">90</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">elevmodel</span> <span class="o">=</span> <span class="n">elevmodel</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="mi">360</span><span class="p">);</span>
                <span class="c1">## Make netCDF file</span>
                <span class="n">ncfile</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/topogrd.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span> 

                <span class="c1">## Define dimension</span>
                <span class="n">lat_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elevmodel</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]));</span>        <span class="c1"># latitude axis</span>
                <span class="n">lon_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elevmodel</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]));</span>       <span class="c1"># longitude axis</span>
                
                <span class="c1">### Define lat/lon with the same names as dimensions to make variables.</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,));</span>
                <span class="n">lat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span><span class="p">;</span> <span class="n">lat</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">;</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,));</span>
                <span class="n">lon</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span><span class="p">;</span> <span class="n">lon</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">;</span>

                <span class="c1">## Define a 2D variable to hold the elevation data</span>
                <span class="n">elev</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;elev&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">))</span>
                <span class="n">elev</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
                <span class="n">elev</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;elevation&#39;</span>
                
                <span class="c1">## Format</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Topography resampled at </span><span class="si">{:0.0f}</span><span class="s1">deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1">## Populate the variables</span>
                <span class="n">lat</span><span class="p">[:]</span>  <span class="o">=</span> <span class="n">latmodel</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">lon</span><span class="p">[:]</span>  <span class="o">=</span> <span class="n">lonmodel</span><span class="p">[</span><span class="mi">0</span><span class="p">,:];</span>
                <span class="n">elev</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">elevmodel</span><span class="p">;</span>
                
                <span class="c1">## Close the netcdf</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> 
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdimage </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/topogrd.nc -JN0/5i -Crelief -P -K -Vq &gt; </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">.ps&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Earth&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.grd.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;wget -O </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.grd.gz https://www.ngdc.noaa.gov/mgg/global/relief/ETOPO1/data/ice_surface/cell_registered/netcdf/ETOPO1_Ice_c_gdal.grd.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.grd&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;yes N | gzip -k -d </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.grd.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdconvert </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.grd </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.nc -fg -Vq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdimage </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/ETOPO1_Ice_c_gdal.nc -JN0/5i -Crelief -P -K -Vq &gt; </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">.ps&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Mars&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/mola32.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;wget -O </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/mola32.nc https://github.com/andrebelem/PlanetaryMaps/raw/v1.0/mola32.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdimage </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/mola32.nc -JN0/5i -Crelief -P -K -Vq &gt; </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">.ps&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Moon&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/LDEM64_PA_pixel_202405.grd&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;wget -O </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/LDEM64_PA_pixel_202405.grd https://pgda.gsfc.nasa.gov/data/LOLA_PA/LDEM64_PA_pixel_202405.grd&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/LDEM64_PA_pixel_202405.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdconvert </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/LDEM64_PA_pixel_202405.grd </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/LDEM64_PA_pixel_202405.nc -fg -Vq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdimage </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/LDEM64_PA_pixel_202405.nc -JN0/5i -Crelief -P -K -Vq &gt; </span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">.ps&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">));</span></div>


<div class="viewcode-block" id="BathyMeasured.readTopo">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyMeasured.readTopo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">readTopo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">new_resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and resample topography to a uniform lat/lon grid.</span>

<span class="sd">        If a resampled NetCDF at the requested resolution already exists, it</span>
<span class="sd">        is read directly; otherwise the raw grid is opened, optionally</span>
<span class="sd">        resampled via GMT for very high input resolutions (&gt;3600 columns),</span>
<span class="sd">        normalized to conventional lat/lon ranges, and then interpolated</span>
<span class="sd">        to a cell-registered grid of spacing ``new_resolution`` degrees</span>
<span class="sd">        using nearest-neighbor interpolation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dir : str</span>
<span class="sd">            Root directory containing the per-body ``topographies`` folder.</span>
<span class="sd">        new_resolution : float, optional</span>
<span class="sd">            Output angular resolution in degrees (e.g., 1, 0.5). Default 1.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, prints array shapes/ranges and plots a global map.</span>

<span class="sd">        Defines</span>
<span class="sd">        -------</span>
<span class="sd">        self.resolution : float</span>
<span class="sd">            Set to ``new_resolution``.</span>
<span class="sd">        self.data_dir : str</span>
<span class="sd">        self.lon, self.lat : ndarray</span>
<span class="sd">            2-D cell-registered longitudes/latitudes (deg).</span>
<span class="sd">        self.elev : ndarray</span>
<span class="sd">            2-D elevation (meters).</span>
<span class="sd">        Also writes the resampled topography NetCDF for reuse.</span>

<span class="sd">        Writes</span>
<span class="sd">        ------</span>
<span class="sd">        {data_dir}/topographies/{Body}/{Body}_resampled_{res}deg.nc</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Input units in km (e.g., some Venus/Moon products) are converted to meters.</span>
<span class="sd">        - Longitudes &gt;180 are wrapped to ``[-180,180]`` and arrays are rolled so that</span>
<span class="sd">          longitudes are monotonic.</span>
<span class="sd">        - The output grid is cell-registered, spanning the full sphere.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the object&#39;s resolution for topography/bathymetry calculations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">new_resolution</span><span class="p">;</span>

        <span class="c1"># Set the location of data storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span><span class="p">;</span>

        <span class="c1"># Define the resampled topography output file name.</span>
        <span class="k">if</span> <span class="n">new_resolution</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_resolution</span><span class="p">):</span>
            <span class="n">resampledTopoPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_resampled_</span><span class="si">{2:0.0f}</span><span class="s2">deg.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">);</span>
        <span class="k">elif</span> <span class="n">new_resolution</span><span class="o">*</span><span class="mi">10</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_resolution</span><span class="o">*</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">resampledTopoPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_resampled_</span><span class="si">{2:0.1f}</span><span class="s2">deg.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_resolution</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_resolution</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_resolution</span> <span class="o">=</span> <span class="n">new_resolution</span><span class="p">;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resolution was set to: </span><span class="si">{}</span><span class="s2"> degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_resolution</span><span class="p">))</span>
            <span class="n">resampledTopoPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/topographies/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_resampled_</span><span class="si">{2:0.1f}</span><span class="s2">deg.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">);</span>

        <span class="c1"># If the resampled topography model already exists then read model</span>
        <span class="c1"># instead of continuing.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resampledTopoPath</span><span class="p">):</span>
            <span class="c1"># Read resampled topography file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">resampledTopoPath</span><span class="p">);</span>

            <span class="c1"># Set latitude/longitude/elev</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:])</span> <span class="p">);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">][:]);</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of input topography arrays&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">));</span>
            
            <span class="c1"># Plot global topography model</span>
            <span class="n">plotHelper</span><span class="o">.</span><span class="n">plotGlobal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">,</span>
                             <span class="n">cmapOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cmap&quot;</span><span class="p">:</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;cbar-title&quot;</span><span class="p">:</span><span class="s2">&quot;cbar-title&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;cbar-range&quot;</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">))]},</span>
                             <span class="n">pltOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;valueType&quot;</span><span class="p">:</span> <span class="s2">&quot;Topography&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;valueUnits&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;plotTitle&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> resampled at </span><span class="si">{:0.0f}</span><span class="s2"> degree resolution&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">),</span>
                                      <span class="s2">&quot;plotZeroContour&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
            <span class="c1"># return</span>
            <span class="k">return</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load netCdf file</span>
            <span class="n">TopoPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/topographies/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fidName</span><span class="p">);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">TopoPath</span><span class="p">);</span>

            <span class="c1"># If the grid is very large (higher than 6 arc minute resoluion) then resample</span>
            <span class="c1"># using gmt then reload netCDF</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]][:])[</span><span class="mi">0</span><span class="p">,:]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
                <span class="c1"># Close dataset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
                <span class="c1"># Resample and reread dataset </span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdsample </span><span class="si">{0}</span><span class="s2"> -Rd -I</span><span class="si">{2}</span><span class="s2">d -rp -G</span><span class="si">{1}</span><span class="s2"> -Vq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TopoPath</span><span class="p">,</span> <span class="n">TopoPath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;_resampled.nc&quot;</span><span class="p">),</span> <span class="n">new_resolution</span><span class="p">))</span>
                <span class="n">TopoPath</span> <span class="o">=</span> <span class="n">TopoPath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;_resampled.nc&quot;</span><span class="p">);</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">TopoPath</span><span class="p">);</span>
                <span class="c1"># Need to redefine the lat/lon/elevation naming scheme</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;elev&quot;</span><span class="p">:</span><span class="s2">&quot;z&quot;</span><span class="p">};</span>

            <span class="c1"># Define latitude/longitude/elevation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]][:]);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]][:]);</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initiallykm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elev_netcdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]][:])</span><span class="o">*</span><span class="mf">1e3</span><span class="p">;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elev_netcdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]][:]);</span>
            
            <span class="c1"># Close file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Check dimenions of lat/lon make mesh grids if not already</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># lat and lon are vectors, not arrays</span>

                <span class="c1"># Make lat and lon into arrays</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">);</span>
            
            <span class="c1"># Make latitude and longitude defined on [-90,90] and [0,360], respectively.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;changing latitude&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="o">&lt;</span><span class="mi">90</span><span class="p">]</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="o">&lt;</span><span class="mi">90</span><span class="p">];</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="o">&gt;</span><span class="mi">90</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="o">&gt;</span><span class="mi">90</span><span class="p">]</span> <span class="o">-</span> <span class="mi">90</span><span class="p">;</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;changing longitude&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span> <span class="o">-</span> <span class="mi">360</span><span class="p">;</span>

                <span class="c1"># Roll all arrays such that they start and end at -180, and 180 longitude, respectively.</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">,</span> <span class="n">columns</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
                <span class="c1">#self.lat_netcdf  = np.roll(self.lat_netcdf, columns+1);</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elev_netcdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev_netcdf</span><span class="p">,</span> <span class="n">columns</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
            
            <span class="c1"># Create grid to interpolate to</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="o">+</span><span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">180</span><span class="o">+</span><span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">90</span><span class="o">-</span><span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="o">-</span><span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">new_resolution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">new_resolution</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">90</span><span class="p">:</span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">new_resolution</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
                <span class="k">while</span> <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">new_resolution</span><span class="p">):</span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">new_resolution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">new_resolution</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">while</span> <span class="o">-</span><span class="mi">180</span><span class="o">&lt;</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">new_resolution</span><span class="p">):</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">new_resolution</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">new_resolution</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">180</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">new_resolution</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
            <span class="c1">#self.lon, self.lat = np.meshgrid(np.arange(-180+new_resolution/2, 180+new_resolution/2, new_resolution), np.arange(90-new_resolution/2, -90-new_resolution/2, -new_resolution) )</span>

            <span class="c1"># Interpolate new latitude/longitude/elevation</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of input topography arrays&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev_netcdf</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="p">));</span>
                <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">elev_netcdf</span><span class="p">));</span>
            
            <span class="n">interp</span> <span class="o">=</span> <span class="n">NearestNDInterpolator</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_netcdf</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_netcdf</span><span class="o">.</span><span class="n">flatten</span><span class="p">())),</span> <span class="bp">self</span><span class="o">.</span><span class="n">elev_netcdf</span><span class="o">.</span><span class="n">flatten</span><span class="p">());</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elev</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">);</span>


            <span class="c1"># Ensure latitude and longitude range from negative to positive values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">);</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">);</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lon</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">);</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">);</span>
    
            <span class="c1"># Write resampled topography to be read for later use.</span>
            
            <span class="c1"># Make ncfile</span>
            <span class="n">ncfile</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">resampledTopoPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span> 

            <span class="c1"># Define dimension</span>
            <span class="n">lat_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]));</span>        <span class="c1"># latitude axis</span>
            <span class="n">lon_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]));</span>       <span class="c1"># longitude axis</span>
            <span class="c1">#elev_dim = ncfile.createDimension(&#39;elev&#39;, self.elev);</span>
            
            <span class="c1"># Define lat/lon with the same names as dimensions to make variables.</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,));</span>
            <span class="n">lat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span><span class="p">;</span> <span class="n">lat</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">;</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,));</span>
            <span class="n">lon</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span><span class="p">;</span> <span class="n">lon</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">;</span>

            <span class="c1"># Define a 2D variable to hold the elevation data</span>
            <span class="n">elev</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;elev&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">))</span>
            <span class="n">elev</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
            <span class="n">elev</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;elevation&#39;</span>
            
            <span class="c1"># Format</span>
            <span class="n">ncfile</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Topography resampled at </span><span class="si">{:0.0f}</span><span class="s1"> degrees.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">)</span>

            <span class="c1"># Populate the variables</span>
            <span class="n">lat</span><span class="p">[:]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">lon</span><span class="p">[:]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:];</span>
            <span class="n">elev</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">;</span>
            
            <span class="c1"># Close the netcdf</span>
            <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> </div>

             
<div class="viewcode-block" id="BathyMeasured.setSeaLevel">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyMeasured.setSeaLevel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setSeaLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">basinVolume</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;uncompactedVol&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                    <span class="n">oceanArea</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">},</span>
                    <span class="n">isostaticCompensation</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derive bathymetry from the resampled topography by flooding.</span>

<span class="sd">        One of two constraints is used::</span>
<span class="sd">        1) **Area constraint** (``oceanArea[&#39;on&#39;]``): Flood until oceans cover</span>
<span class="sd">           the specified decimal fraction of the globe.</span>
<span class="sd">        2) **Volume constraint** (``basinVolume[&#39;on&#39;]``): Flood until the total</span>
<span class="sd">           ocean volume equals ``uncompactedVol`` (m³).</span>

<span class="sd">        Optionally, a placeholder is provided for isostatic compensation of</span>
<span class="sd">        water loading (not implemented).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        basinVolume : dict</span>
<span class="sd">            ``{&quot;on&quot;: bool, &quot;uncompactedVol&quot;: float or None}``. Enable and set</span>
<span class="sd">            the target ocean volume (m³).</span>
<span class="sd">        oceanArea : dict</span>
<span class="sd">            ``{&quot;on&quot;: bool, &quot;area&quot;: float}``. Enable and set target ocean area</span>
<span class="sd">            as a decimal fraction (e.g., 0.7 for 70%).</span>
<span class="sd">        isostaticCompensation : dict</span>
<span class="sd">            ``{&quot;on&quot;: bool}``. If True, calls a placeholder routine</span>
<span class="sd">            (currently non-functional).</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, prints progress when using the volume method.</span>

<span class="sd">        Defines</span>
<span class="sd">        -------</span>
<span class="sd">        self.bathymetry : ndarray</span>
<span class="sd">            Seafloor depth (meters, positive); land cells are NaN.</span>
<span class="sd">        self.areaWeights : ndarray</span>
<span class="sd">            Per-cell area weights (m²) from a spherical model at planet radius.</span>
<span class="sd">        self.AOC : float</span>
<span class="sd">            Ocean surface area (m²).</span>
<span class="sd">        self.VOC : float</span>
<span class="sd">            Ocean volume (m³).</span>
<span class="sd">        self.highlatlat, self.highlatA : float</span>
<span class="sd">            High-latitude cutoff latitude (deg) and high-latitude ocean area (m²),</span>
<span class="sd">            via ``calculateHighLatA``.</span>
<span class="sd">        self.bathymetryAreaDist, self.bathymetryAreaDist_wHighlat : ndarray</span>
<span class="sd">            Global bathymetry distributions (excluding/including high-latitude),</span>
<span class="sd">            via ``calculateBathymetryDistributionGlobal``.</span>
<span class="sd">        self.binEdges : ndarray</span>
<span class="sd">            Bin edges (km) used for distributions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Flooding is applied as an incremental sea-level rise (1 m steps for</span>
<span class="sd">          area constraint, 10 m steps for volume constraint) until the target</span>
<span class="sd">          is met.</span>
<span class="sd">        - Requires helper functions available as ``utils.areaWeights``,</span>
<span class="sd">          ``calculateHighLatA`` and ``calculateBathymetryDistributionGlobal``.</span>
<span class="sd">        - The isostatic compensation routine is a stub.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define methods for creating bathymetry models.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">oceanAreaMethod</span><span class="p">(</span><span class="n">topography</span><span class="p">,</span> <span class="n">oceanArea</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">isostaticCompensation</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            oceanAreaMethod method is use to calculate and define bathymetry as the</span>
<span class="sd">            topography flooded until the oceans cover some decimal percentage of </span>
<span class="sd">            the planet.</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            topography : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing cell registered topography, in m.</span>
<span class="sd">            oceanArea : DICTIONARY</span>
<span class="sd">                Option to define bathymetry by flooding topography until</span>
<span class="sd">                oceanArea[&#39;area&#39;], decimal percent, of global area is covered</span>
<span class="sd">                with oceans.</span>
<span class="sd">            areaWeights : NUMPY ARRAY</span>
<span class="sd">                An array of global degree to area weights. The size is dependent on</span>
<span class="sd">                input resolution. The sum of the array equals 4 pi radius^2 for </span>
<span class="sd">                sufficiently high resolution, in m2.</span>
<span class="sd">            isostaticCompensation : DICTIONARY</span>
<span class="sd">                An option to apply isostatic compensation to for ocean loading</span>
<span class="sd">                on the topography. Option assumes a uniform physical properties</span>
<span class="sd">                of the lithosphere.</span>
<span class="sd">            verbose : BOOLEAN, optional</span>
<span class="sd">                Reports more information about process. The default is True.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            bathymetry : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing seafloor depth, in m, with positive values.</span>
<span class="sd">                Bathymetry is define by the method of this function. Any areas above</span>
<span class="sd">                sea-level are assigned a value of np.nan.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Iterate flooding (meter-by-meter) until the desired amount of ocean</span>
            <span class="c1"># planetary surface area is flooded.</span>
            <span class="n">calculatedOceanAreaDPercent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">deepestSeafloor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="n">calculatedOceanAreaDPercent</span> <span class="o">&lt;</span> <span class="n">oceanArea</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]:</span>
                <span class="c1"># Add 1 meter of flooding</span>
                <span class="n">deepestSeafloor</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">bathymetry</span> <span class="o">=</span> <span class="n">topography</span><span class="o">-</span><span class="n">deepestSeafloor</span><span class="p">;</span>
                <span class="c1"># Do isostatic compensation calculation for ocean loading</span>
                <span class="k">if</span> <span class="n">isostaticCompensation</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">]:</span>
                    <span class="n">bathymetry</span> <span class="o">=</span> <span class="n">isostaticCompensationMethod</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
                <span class="c1"># Calculate ocean area, in m2.</span>
                <span class="n">AOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">areaWeights</span><span class="p">[</span><span class="n">bathymetry</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
                <span class="c1"># Calculate ocean area, in decimal percent.</span>
                <span class="n">calculatedOceanAreaDPercent</span> <span class="o">=</span> <span class="n">AOC</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">areaWeights</span> <span class="p">));</span>
        
            <span class="c1"># Set topography in bathymetry variable to np.nan.</span>
            <span class="n">bathymetry</span><span class="p">[</span><span class="n">bathymetry</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">waterVolumeMethod</span><span class="p">(</span><span class="n">topography</span><span class="p">,</span> <span class="n">basinVolume</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">isostaticCompensation</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            waterVolumeMethod method is use to calculate and define bathymetry as the</span>
<span class="sd">            topography flooded until the oceans contain some input value of ocean</span>
<span class="sd">            water, in m3.</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            topography : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing cell registered topography, in m.</span>
<span class="sd">            basinVolume : DICTIONARY</span>
<span class="sd">                Option to define bathymetry by flooding topography with</span>
<span class="sd">                basinVolume[&#39;uncompactedVol&#39;] amount of ocean water, in m3.</span>
<span class="sd">            areaWeights : NUMPY ARRAY</span>
<span class="sd">                An array of global degree to area weights. The size is dependent on</span>
<span class="sd">                input resolution. The sum of the array equals 4 pi radius^2 for </span>
<span class="sd">                sufficiently high resolution, in m2.</span>
<span class="sd">            isostaticCompensation : DICTIONARY</span>
<span class="sd">                An option to apply isostatic compensation to for ocean loading</span>
<span class="sd">                on the topography. Option assumes a uniform physical properties</span>
<span class="sd">                of the lithosphere.</span>
<span class="sd">            verbose : BOOLEAN, optional</span>
<span class="sd">                Reports more information about process. The default is True.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            bathymetry : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing seafloor depth, in m, with positive values.</span>
<span class="sd">                Bathymetry is define by the method of this function. Any areas above</span>
<span class="sd">                sea-level are assigned a value of np.nan.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Iterate flooding (meter-by-meter) until the desired amount of ocean</span>
            <span class="c1"># volume produced.</span>
            <span class="n">VOC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">deepestSeafloor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="n">VOC</span> <span class="o">&lt;</span> <span class="n">basinVolume</span><span class="p">[</span><span class="s1">&#39;uncompactedVol&#39;</span><span class="p">]:</span>
                <span class="c1"># Add 10 meter of flooding</span>
                <span class="n">deepestSeafloor</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
                <span class="n">bathymetry</span> <span class="o">=</span> <span class="n">topography</span><span class="o">-</span><span class="n">deepestSeafloor</span><span class="p">;</span>
                <span class="c1"># Do isostatic compensation calculation for ocean loading</span>
                <span class="k">if</span> <span class="n">isostaticCompensation</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">]:</span>
                    <span class="n">bathymetry</span> <span class="o">=</span> <span class="n">isostaticCompensationMethod</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
                <span class="c1"># Calculate basin volume, in m3.</span>
                <span class="n">VOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">bathymetry</span><span class="p">[</span><span class="n">bathymetry</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">bathymetry</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span> <span class="p">);</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deepest seafloor is </span><span class="si">{0:2.0f}</span><span class="s2"> m with total basin volume of </span><span class="si">{1:2.2e}</span><span class="s2"> m3&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deepestSeafloor</span><span class="p">,</span> <span class="n">VOC</span><span class="p">))</span>

            <span class="c1"># Set topography in bathymetry variable to np.nan.</span>
            <span class="n">bathymetry</span><span class="p">[</span><span class="n">bathymetry</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">;</span> 

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span>            

        <span class="k">def</span><span class="w"> </span><span class="nf">isostaticCompensationMethod</span><span class="p">(</span><span class="n">topography</span><span class="p">,</span>  <span class="n">loadingProp</span><span class="p">,</span> <span class="n">lithosphereProp</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            isostaticCompensationMethod is a method used to recalculate bathymetry</span>
<span class="sd">            due to the loading of lithosphere.</span>

<span class="sd">            topography : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing cell registered topography, in m. Note</span>
<span class="sd">                that there should be some bathymetry (represented with negative</span>
<span class="sd">                values in the topography array).</span>
<span class="sd">            loadingProp : Dictionary</span>
<span class="sd">                A dictionary of loading material properties. This should include the</span>
<span class="sd">                following properties</span>
<span class="sd">                    &#39;uniformDensity&#39; : loading material density, in kg/m3</span>
<span class="sd">            lithosphereProp : DICTIONARY</span>
<span class="sd">                A dictionary representing loaded lithosphere properties. </span>

<span class="sd">            </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            bathymetry : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing seafloor depth, in m, with negative values,</span>
<span class="sd">                and topography with positive values.</span>







<span class="sd">            1. Might be useful for flexural Isostasy:</span>
<span class="sd">                https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2017JB014571</span>
<span class="sd">                https://pages.uoregon.edu/rdorsey/BasinAnalysis/AngevineEtal1990/Chapt%205%20Flexure.pdf</span>
<span class="sd">            2. Might be useful for the Isostasy</span>
<span class="sd">                https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2017GL073334</span>


<span class="sd">            &quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;working progress&quot;</span><span class="p">)</span>

        <span class="c1"># Show options chosen for bathymetry model creation</span>
        <span class="n">methodChoice</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
        <span class="n">methodChoice</span>
        <span class="k">if</span> <span class="n">basinVolume</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">]:</span>
            <span class="n">methodChoice</span> <span class="o">=</span> <span class="s2">&quot;basin volume constraint&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">oceanArea</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">methodChoice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">methodChoice</span> <span class="o">=</span> <span class="s2">&quot;basin area constraint&quot;</span><span class="p">;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> was also chosen. Using </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">methodChoice</span><span class="p">));</span>

        
        <span class="c1"># Define degree to area weights</span>
        <span class="n">areaWeights</span><span class="p">,</span> <span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">totalArea</span><span class="p">,</span> <span class="n">totalAreaCalculated</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">(</span><span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span> <span class="o">=</span> <span class="n">areaWeights</span><span class="p">;</span>

        <span class="c1"># Define initial bathymetry model with minimum elevation set to 0 m (sea-level)</span>
        <span class="c1"># Note that topography represents values above sea-level with positive values.</span>
        <span class="n">topography</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elev</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">));</span>

        <span class="c1"># Feed bathymetry initial model into selected bathymetry calculation function. </span>
        <span class="k">if</span> <span class="n">methodChoice</span> <span class="o">==</span> <span class="s2">&quot;basin volume constraint&quot;</span><span class="p">:</span>
            <span class="n">bathymetry</span> <span class="o">=</span> <span class="n">waterVolumeMethod</span><span class="p">(</span><span class="n">topography</span><span class="p">,</span> <span class="n">basinVolume</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">isostaticCompensation</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">methodChoice</span> <span class="o">==</span> <span class="s2">&quot;basin area constraint&quot;</span><span class="p">:</span>
            <span class="n">bathymetry</span> <span class="o">=</span> <span class="n">oceanAreaMethod</span><span class="p">(</span><span class="n">topography</span><span class="p">,</span> <span class="n">oceanArea</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">isostaticCompensation</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Calculate and define properties of bathymetry model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span> <span class="o">=</span> <span class="n">bathymetry</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span> <span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">)]</span> <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">bathymetry</span><span class="o">*</span><span class="n">areaWeights</span><span class="p">)[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">)]</span> <span class="p">))</span>
        
        <span class="c1">## Sets self.highlatA and self.highlatlat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatA</span> <span class="o">=</span> <span class="n">calculateHighLatA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

        <span class="c1">## Define global distribution of sea seafloor depths</span>
        <span class="c1">## Both self.bathymetryAreaDist and self.bathymetryAreaDist_wHighlat</span>
        <span class="c1">## are define here.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span> <span class="o">=</span> <span class="n">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span></div>


<div class="viewcode-block" id="BathyMeasured.saveBathymetry">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyMeasured.saveBathymetry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">saveBathymetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the derived bathymetry and summary parameters to NetCDF.</span>

<span class="sd">        The output file contains gridded bathymetry plus global area weights,</span>
<span class="sd">        bathymetry distributions (with/without high-latitude region),</span>
<span class="sd">        bin edges, and scalar integrals (AOC, VOC, etc.).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, creates the output directory tree if needed</span>
<span class="sd">            and prints paths/actions.</span>

<span class="sd">        Writes</span>
<span class="sd">        ------</span>
<span class="sd">        {data_dir}/bathymetries/{Body}/{Body}_resampled_{res}deg.nc</span>
<span class="sd">            Variables:</span>
<span class="sd">              - ``bathymetry(lat,lon)`` : m</span>
<span class="sd">              - ``lat(lat)`` : deg_north</span>
<span class="sd">              - ``lon(lon)`` : deg_east</span>
<span class="sd">              - ``areaWeights(lat)`` : m² (per-latitude row representative)</span>
<span class="sd">              - ``binEdges(binEdges)`` : km</span>
<span class="sd">              - ``bathymetry-distribution-G(binEdges)`` : kernel distribution</span>
<span class="sd">              - ``bathymetry-distribution-whighlat-G(binEdges)`` : kernel distribution</span>
<span class="sd">              - ``highlatlat`` : deg</span>
<span class="sd">              - ``highlatA`` : m²</span>
<span class="sd">              - ``VOC`` : m³</span>
<span class="sd">              - ``AOC`` : m²</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The latitude/longitude axes are written as vectors paired with</span>
<span class="sd">          cell-registered 2-D data.</span>
<span class="sd">        - Title metadata encodes the body and resolution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make directory for storing bathymetry model(s)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_file_structure</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries/Earth&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries/Venus&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries/Mars&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries/Moon&quot;</span><span class="p">],</span>
                                     <span class="n">root</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>     
        
        <span class="c1"># Set netCDF4 filename</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">):</span>
            <span class="n">BathyPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/bathymetries/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_resampled_</span><span class="si">{2:0.1f}</span><span class="s2">deg.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">);</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="o">*</span><span class="mi">10</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="o">*</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">BathyPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/bathymetries/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_resampled_</span><span class="si">{2:0.1f}</span><span class="s2">deg.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">);</span>
        <span class="c1">#BathyPath = &quot;{0}/bathymetries/{1}/{1}_resampled_{2:0.0f}deg.nc&quot;.format(self.data_dir,  self.model, self.resolution);</span>
        
        <span class="c1"># Make new .nc file</span>
        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">BathyPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span> 

        <span class="c1"># Define dimension (latitude, longitude, and bathymetry distributions)</span>
        <span class="n">lat_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]));</span>     <span class="c1"># latitude axis</span>
        <span class="n">lon_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]));</span>     <span class="c1"># longitude axis</span>
        <span class="n">binEdges_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]));</span>      <span class="c1"># distribution</span>
        
        <span class="c1"># Define lat/lon with the same names as dimensions to make variables.</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,));</span>
        <span class="n">lat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span><span class="p">;</span> <span class="n">lat</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">;</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">;</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">];</span>

        <span class="n">lon</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,));</span>
        <span class="n">lon</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span><span class="p">;</span> <span class="n">lon</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">;</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">];</span>

        <span class="c1"># Define a 2D variable to hold the elevation data</span>
        <span class="n">bathy</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;bathymetry&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">))</span>
        <span class="n">bathy</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
        <span class="n">bathy</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;bathymetry&#39;</span>

        <span class="c1"># Define vector as function with longitude dependence</span>
        <span class="n">areaWeights</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;areaWeights&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,(</span><span class="s1">&#39;lat&#39;</span><span class="p">,))</span>
        <span class="n">areaWeights</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters sq&#39;</span>
        <span class="n">areaWeights</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;areaWeights&#39;</span>

        <span class="c1"># Define variables for bathymetry distributions (vectors)</span>
        <span class="n">binEdges</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,));</span>
        <span class="n">binEdges</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span><span class="p">;</span> <span class="n">binEdges</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;km depth&#39;</span><span class="p">;</span>

        <span class="n">distribution_whighlat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;bathymetry-distribution-whighlat-G&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,))</span>
        <span class="n">distribution_whighlat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;kernel distribution&#39;</span>
        <span class="n">distribution_whighlat</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;bathymetry-distribution-whighlat-G&#39;</span>

        <span class="n">distribution</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;bathymetry-distribution-G&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,))</span>
        <span class="n">distribution</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;kernel distribution&#39;</span>
        <span class="n">distribution</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;bathymetry-distribution-G&#39;</span>

        <span class="c1"># Define single values parameters (e.g., VOC, AOC, high latitude cutoff)</span>
        <span class="n">highlatlat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;highlatlat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">highlatlat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">highlatlat</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;highlatlat&#39;</span>

        <span class="n">highlatA</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;highlatA&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">highlatA</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters sq&#39;</span>
        <span class="n">highlatA</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;highlatA&#39;</span>

        <span class="n">VOC</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;VOC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">VOC</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters cubed&#39;</span>
        <span class="n">VOC</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;VOC&#39;</span>

        <span class="n">AOC</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;AOC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">AOC</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters sq&#39;</span>
        <span class="n">AOC</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;AOC&#39;</span>
        
        <span class="c1"># Format title</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Bathymetry created from topography resampled at </span><span class="si">{:0.1f}</span><span class="s1"> degrees.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>

        <span class="c1"># Populate the variables</span>
        <span class="n">lat</span><span class="p">[:]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">lon</span><span class="p">[:]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:];</span>
        <span class="n">bathy</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">;</span>
        <span class="n">areaWeights</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>

        <span class="c1"># Add bathymetry distribution information</span>
        <span class="n">distribution_whighlat</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">;</span>
        <span class="n">distribution</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="p">;</span>
        <span class="n">binEdges</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:];</span>

        <span class="c1"># Add attributes</span>
        <span class="n">highlatlat</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span><span class="p">;</span>
        <span class="n">highlatA</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatA</span><span class="p">;</span>
        <span class="n">VOC</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span><span class="p">;</span>
        <span class="n">AOC</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AOC</span><span class="p">;</span>

        <span class="c1"># Close the netcdf</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>


<div class="viewcode-block" id="BathyMeasured.readBathymetry">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyMeasured.readBathymetry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">readBathymetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a previously saved bathymetry NetCDF for this body/resolution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Unused here (reserved for symmetry with other methods).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Side Effects</span>
<span class="sd">        ------------</span>
<span class="sd">        Opens and stores a handle to the dataset at</span>
<span class="sd">        ``self.bathync = Dataset(path, &#39;r&#39;)``. The path is resolved using</span>
<span class="sd">        ``self.data_dir``, ``self.model``, and ``self.resolution``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">):</span>
            <span class="n">BathyPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/bathymetries/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_resampled_</span><span class="si">{2:0.0f}</span><span class="s2">deg.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">);</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="o">*</span><span class="mi">10</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="o">*</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">BathyPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/bathymetries/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_resampled_</span><span class="si">{2:0.1f}</span><span class="s2">deg.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">);</span>
        
        <span class="c1"># Make new .nc file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bathync</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">BathyPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span> </div>
</div>



<div class="viewcode-block" id="BathyRecon">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BathyRecon</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reconstructs global Earth bathymetry through time using a workflow</span>
<span class="sd">    modeled after Bogumil et al. (2024, PNAS, doi:10.1073/pnas.2400232121).</span>

<span class="sd">    Pipeline (conceptual)</span>
<span class="sd">    ---------------------</span>
<span class="sd">    1. Convert reconstructed oceanic lithosphere age (paleo-isochrons)</span>
<span class="sd">       to first-order bathymetry via a chosen age–depth relation.</span>
<span class="sd">    2. Add isostatically compensated deep-marine sediment thickness</span>
<span class="sd">       using an empirical age/latitude relationship.</span>
<span class="sd">    3. Fill continental shelves, flooded continents, and deep marine</span>
<span class="sd">       not represented by plate reconstructions with paleoDEMs.</span>
<span class="sd">    4. Apply a eustatic sea-level adjustment (Haq87 long-term curve).</span>
<span class="sd">    5. Deform the global bathymetry distribution to match present-day</span>
<span class="sd">       uncertainty and reproduce target ocean-container volumes (VOC).</span>

<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    This class expects directory trees with NetCDF grids for:</span>
<span class="sd">      • paleoDEMs:  files named like  &lt;prefix&gt;_&lt;Age&gt;Ma.nc</span>
<span class="sd">      • oceanLith:  files named like  &lt;prefix&gt;-&lt;Age&gt;.nc</span>
<span class="sd">      • etopo:      present-day topography/bathymetry NetCDF (single file)</span>

<span class="sd">    Attributes (high level)</span>
<span class="sd">    -----------------------</span>
<span class="sd">    directories : dict</span>
<span class="sd">        Paths for &#39;paleoDEMs&#39;, &#39;oceanLith&#39;, and &#39;etopo&#39;.</span>
<span class="sd">    ESL : pandas.DataFrame</span>
<span class="sd">        Long-term Haq87 eustatic sea-level curve with columns [&#39;Ma&#39;,&#39;m&#39;].</span>
<span class="sd">    radiuskm : float</span>
<span class="sd">        Earth radius (km), default 6371.0.</span>
<span class="sd">    thermalSubMethod : dict</span>
<span class="sd">        Thermal subsidence method settings (see `setThermalMethod`).</span>
<span class="sd">    VOCValuesPD, VOCValues, VOCAgeValues : ndarray</span>
<span class="sd">        Present-day and time-dependent target ocean volumes and their ages.</span>
<span class="sd">    paleoDEMsfids, paleoDEMsAges : ndarray</span>
<span class="sd">        PaleodeM filenames and their parsed ages (Ma).</span>
<span class="sd">    oceanLithfids, oceanLithReconAges : ndarray</span>
<span class="sd">        Lithosphere-age filenames and their parsed ages (Ma).</span>
<span class="sd">    etopofid : str</span>
<span class="sd">        Filename for present-day ETOPO/Topo NetCDF.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    • Many steps call external tools (`gmt`, `wget`) and assume they are on PATH.</span>
<span class="sd">    • Numerous intermediate arrays (e.g., `self.topography`, `self.bathymetry`,</span>
<span class="sd">      `self.areaWeights`, etc.) are defined during `run` or helper methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directories</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the reconstruction with source directories and sea-level curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directories : dict</span>
<span class="sd">            Must contain:</span>
<span class="sd">              - &#39;paleoDEMs&#39; : path to paleo digital elevation models (NetCDF).</span>
<span class="sd">              - &#39;oceanLith&#39; : path to ocean lithosphere age grids (NetCDF).</span>
<span class="sd">              - &#39;etopo&#39;     : path to directory with a single present-day NetCDF.</span>

<span class="sd">            File naming conventions are assumed:</span>
<span class="sd">              • paleoDEMs: &lt;prefix&gt;_&lt;Age&gt;Ma.nc (Age as float/int)</span>
<span class="sd">              • oceanLith: &lt;prefix&gt;-&lt;Age&gt;.nc   (Age as float/int)</span>

<span class="sd">        Defines</span>
<span class="sd">        -------</span>
<span class="sd">        self.ESL : pandas.DataFrame</span>
<span class="sd">            Haq87 long-term sea-level curve with columns [&#39;Ma&#39;,&#39;m&#39;].</span>
<span class="sd">        self.directories : dict</span>
<span class="sd">            Stored copy of input directories.</span>
<span class="sd">        self.paleoDEMsfids, self.paleoDEMsAges : ndarray</span>
<span class="sd">            Filenames and parsed ages (Ma) for paleoDEMs.</span>
<span class="sd">        self.oceanLithfids, self.oceanLithReconAges : ndarray</span>
<span class="sd">            Filenames and parsed ages (Ma) for lithosphere age grids.</span>
<span class="sd">        self.etopofid : str</span>
<span class="sd">            Resolved present-day ETOPO/Topo filename (first if multiple found).</span>
<span class="sd">        self.radiuskm : float</span>
<span class="sd">            Earth radius (km).</span>
<span class="sd">        self.thermalSubMethod : dict</span>
<span class="sd">            Default thermal subsidence method {&#39;type&#39;: &#39;CM2009&#39;}.</span>
<span class="sd">        self.VOCValuesPD, self.VOCValues, self.VOCAgeValues : ndarray</span>
<span class="sd">            Default VOC targets (constant by default).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Expects the included Haq87 curve at `IncludedData/Haq87_SealevelCurve_Longterm.dat`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the directories to read </span>
        <span class="n">filenameESL</span>     <span class="o">=</span> <span class="s1">&#39;/IncludedData/Haq87_SealevelCurve_Longterm.dat&#39;</span><span class="p">;</span>
        <span class="n">pathScript</span>      <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">));</span>

        <span class="c1"># Read ESL curve </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ESL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pathScript</span><span class="o">+</span><span class="n">filenameESL</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ma&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Define the directories dictionary attribute and check that appropriate paths</span>
        <span class="c1"># have been defined.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directories</span> <span class="o">=</span> <span class="n">directories</span><span class="p">;</span>

        <span class="c1"># Check that all directories exist</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="c1"># Set paleoDEM directory/file information</span>
        <span class="c1">## Set filenames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paleoDEMsfids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="s1">&#39;paleoDEMs&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;.cache&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;.nc&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)]);</span>
        <span class="c1">## Set reconstruction ages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paleoDEMsAges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Ma.nc&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paleoDEMsfids</span><span class="p">]);</span>

        <span class="c1"># Set paleoDEM directory/file information</span>
        <span class="c1">## Set filenames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithfids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="s1">&#39;oceanLith&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;.cache&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;.nc&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)]);</span>
        <span class="c1">## Set reconstruction ages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithReconAges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithfids</span><span class="p">]);</span>

        <span class="c1"># Set etopo directory/file information</span>
        <span class="c1">## Set filenames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;.cache&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;.nc&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)]);</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple netCDF4 files were read from the given etopo directory: </span><span class="si">{0}</span><span class="s2">.</span><span class="se">\n</span><span class="si">{1}</span><span class="s2"> will be read and used as the present-day topography throughout this analysis&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        
        <span class="c1"># Set the radius of planet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span> <span class="o">=</span> <span class="mf">6371.0</span><span class="p">;</span>

        <span class="c1"># Set the default thermal subsidence method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s2">&quot;CM2009&quot;</span><span class="p">};</span>
    
        <span class="c1"># Ocean basin volume is defined based on analysis from Bogumil et al. (2024) https://doi.org/10.1073/pnas.2400232121.</span>
        <span class="n">constVOC</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VOCValuesPD</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.3350350e+18</span><span class="p">]);</span> <span class="c1"># From downsampled topo6 as defined in https://doi.org/10.1073/pnas.2400232121</span>
        <span class="k">if</span> <span class="n">constVOC</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ocean basin volume is constant through reconstruction period.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOCValues</span>      <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCValuesPD</span><span class="p">);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># As defined as in Bogumil et al. (2024) https://doi.org/10.1073/pnas.2400232121</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOCValues</span> <span class="o">=</span> <span class="mf">1.3350350e+18</span><span class="p">;</span> <span class="c1"># From downsampled topo6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
            <span class="c1"># percent of total surface water stored in glaciers which would be ocean</span>
            <span class="c1"># water at studied time period.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOCValues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span><span class="p">);</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">:</span>
                    <span class="n">per_ice_melt</span> <span class="o">=</span> <span class="mf">2.1</span><span class="p">;</span>         <span class="c1"># [%] - No glaciers</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">40</span><span class="p">):</span>
                    <span class="n">per_ice_melt</span> <span class="o">=</span> <span class="mf">2.1</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>       <span class="c1"># [%] - Half glacier volume</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">per_ice_melt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="c1"># [%] - Present day glaciers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VOCValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">per_ice_melt</span><span class="p">))</span><span class="o">*</span><span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCValuesPD</span><span class="p">);</span>

<div class="viewcode-block" id="BathyRecon.setThermalMethod">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.setThermalMethod">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setThermalMethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thermalSubMethod</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s2">&quot;CM2009&quot;</span><span class="p">},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Choose the age–depth relationship used for thermal subsidence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        thermalSubMethod : dict, optional</span>
<span class="sd">            For &#39;CM2009&#39;:</span>
<span class="sd">                {&#39;type&#39;: &#39;CM2009&#39;}</span>
<span class="sd">            For &#39;RK2021&#39;:</span>
<span class="sd">                {&#39;type&#39;: &#39;RK2021&#39;, &#39;H&#39;: &lt;float W/m/K&gt;, &#39;MORDepthkm&#39;: &lt;float&gt;}</span>
<span class="sd">            Suggested H values: 2.1e-12 (PD), 3.2e-12 (1.7 Ga), 4.8e-12 (2.8 Ga), 6.4e-12 (3.5 Ga), 8e-12 (3.95 Ga).</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, prints guidance when H differs from tabulated values.</span>

<span class="sd">        Redefines</span>
<span class="sd">        ---------</span>
<span class="sd">        self.thermalSubMethod : dict</span>
<span class="sd">            Method dictionary used by `addThermalSub`.</span>

<span class="sd">        Options</span>
<span class="sd">        • &#39;CM2009&#39; (default): Crosby &amp; McKenzie (2009) piecewise age–depth relation.</span>
<span class="sd">        • &#39;RK2021&#39;         : Rosas &amp; Korenaga (2021) parameterized model supporting</span>
<span class="sd">                              variable internal heating H and MOR depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set method to use for thermal subsidence of ocean lithosphere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;RK2021&quot;</span><span class="p">:</span>
            <span class="c1"># Set interval heating value if RK2021 meethod is used.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">];</span>

            <span class="c1"># Set mid-ocean-ridge depth</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;MORDepthkm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;MORDepthkm&#39;</span><span class="p">];</span>

            <span class="c1"># Report</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">HAvailable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.1e-12</span><span class="p">,</span> <span class="mf">3.2e-12</span><span class="p">,</span> <span class="mf">4.8e-12</span><span class="p">,</span> <span class="mf">6.4e-12</span><span class="p">,</span> <span class="mf">8e-12</span><span class="p">]);</span>
                <span class="c1">## Find the closest H value from the RK2021 paper</span>
                <span class="c1">## Find the index of that internal heating value</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">HAvailable</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">HAvailable</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">HAvailable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">User defined internal heating </span><span class="si">{:1.1e}</span><span class="s2"> [W/m/K] is </span><span class="si">{:0.0f}</span><span class="s2">% (large/small) than the closest internal heating value used in RK2021 (</span><span class="si">{:1.1e}</span><span class="s2"> [W/m/K]). H = </span><span class="si">{:1.1e}</span><span class="s2"> [W/m/K] will be used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span>
                                                                                                                                                                                                                       <span class="o">-</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">HAvailable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span>
                                                                                                                                                                                                                       <span class="n">HAvailable</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                                                                                                                                       <span class="n">HAvailable</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Internal heating values of H [W/m/K] = 2.1e-12 (present-day) 3.2e-12 (1.7 Ga), 4.8e-12 (2.8 Ga), 6.4e-12 (3.5 Ga), and 8e-12 (3.95 Ga) available for analysis.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BathyRecon.run">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startMa</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">endMa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">deltaMyr</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">maxBasinCnt</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">findBasins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the reconstruction loop and save outputs (per time slice).</span>

<span class="sd">        Steps (per time slice)</span>
<span class="sd">        ----------------------</span>
<span class="sd">        1. Read/prepare lithosphere age grid and initialize topography.</span>
<span class="sd">        2. Add thermal subsidence via `addThermalSub`.</span>
<span class="sd">        3. Add sediment thickness and isostatic compensation.</span>
<span class="sd">        4. Merge paleoDEMs for continental/flooded regions.</span>
<span class="sd">        5. Apply eustatic sea-level adjustment (Haq87; optionally scaled).</span>
<span class="sd">        6. Compute area weights, bathymetry, and global diagnostics (AOC/VOC).</span>
<span class="sd">        7. For &#39;CM2009&#39;: optionally apply volume-of-ocean (VOC) correction</span>
<span class="sd">           based on present-day mismatch (`addVOCCorrection`).</span>
<span class="sd">        8. Identify/merge basins and compute basin parameters/connectivity.</span>
<span class="sd">        9. Save bathymetry and basin outputs for ExoCcycle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        startMa : int, optional</span>
<span class="sd">            Oldest reconstruction age (Ma). Default 80.</span>
<span class="sd">        endMa : int, optional</span>
<span class="sd">            Youngest reconstruction age (Ma). Default 0.</span>
<span class="sd">        deltaMyr : int, optional</span>
<span class="sd">            Temporal step (Myr). Default 5.</span>
<span class="sd">        resolution : float, optional</span>
<span class="sd">            Spatial grid resolution (degrees). Default 1.</span>
<span class="sd">        maxBasinCnt : int, optional</span>
<span class="sd">            Maximum number of allowed basins for merging heuristics.</span>
<span class="sd">        findBasins : bool, optional</span>
<span class="sd">            If True, perform basin identification/merging workflow.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, print progress and generate quick looks.</span>

<span class="sd">        Side Effects</span>
<span class="sd">        ------------</span>
<span class="sd">        • Writes per-age NetCDF files via `saveBathymetry`.</span>
<span class="sd">        • Creates/updates `self.basins` with computed basin properties.</span>
<span class="sd">        • May create plots/diagnostics when `verbose=True`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Requires helper utilities from `utils` and external GMT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define all periods to bathymetry for.</span>
        <span class="n">reconAgeVec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">endMa</span><span class="p">,</span> <span class="n">startMa</span><span class="o">+</span><span class="n">deltaMyr</span><span class="p">,</span> <span class="n">deltaMyr</span><span class="p">));</span>

        <span class="c1"># Loop over all periods.</span>
        <span class="k">for</span> <span class="n">reconAge</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pbar</span> <span class="o">:=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">reconAgeVec</span><span class="p">)):</span>
            <span class="c1"># 1. Add ocean lithosphere age-depth relationship </span>
            <span class="c1"># 1a. Read ocean lithosphere age grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOceanLithosphereAgeGrid</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">reconAge</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fuzzyAge</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
            <span class="c1"># 1b. Define topography, latitude, and longitude arrays using ocean lithosphere inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topography</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">));</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">;</span>

            <span class="c1"># 1c. Use age grid to calculate seafloor depth from age-depth relationship</span>
            <span class="c1"># Note that bathymetry is represented with positive values.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topography</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addThermalSub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
            
            <span class="c1"># 2. Isostatically compensation (sed thickness, litho age) that also include</span>
            <span class="c1"># sediment thickness.</span>
            <span class="c1"># Note that bathymetry is represented with positive values.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topography</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIsostaticCorrection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># 3. Add paleoDEM</span>
            <span class="c1"># 3a. Read paleoDEM (defined as self.paleoDEM)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getDEM</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">reconAge</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fuzzyAge</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

            <span class="c1"># 3b. Add paleoDEM</span>
            <span class="c1"># Note that bathymetry will now be represented with negative values.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topography</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paleoDEM</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>

            <span class="c1"># 4. Add eustatic sea-level curve to represent flooding.</span>
            <span class="c1"># Note that this change in sea-level is only applied over ocean</span>
            <span class="c1"># seafloor modeled with seafloor ages (i.e., seafloor represented</span>
            <span class="c1"># by paleoDEMs is not changed). The sealevel is also applied at</span>
            <span class="c1"># 65% of its value which is consistent with continental flooding</span>
            <span class="c1"># (see https://www.earthbyte.org/webdav/ftp/Data_Collections/Scotese_Wright_2018_PaleoDEM/Scotese_Wright2018_PALEOMAP_PaleoDEMs.pdf) </span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CM2009&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">,</span> <span class="n">ESLi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getESL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">reconAge</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">.65</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

            <span class="c1"># 5. Close the ocean lithospheric age grids netCDF4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># 6. Create global area weights array</span>
            <span class="k">if</span> <span class="n">reconAge</span> <span class="o">==</span> <span class="n">reconAgeVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">areaWeights</span><span class="p">,</span> <span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">totalArea</span><span class="p">,</span> <span class="n">totalAreaCalculated</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">(</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radiuskm</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span> <span class="o">=</span> <span class="n">areaWeights</span><span class="p">;</span>
            
            <span class="c1"># 7. Define bathymetry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topography</span><span class="p">);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span>

            <span class="c1"># 8. Calculate and define properties of bathymetry model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span> <span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">)]</span> <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="o">*</span><span class="n">areaWeights</span><span class="p">)[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">)]</span> <span class="p">))</span>
            
            <span class="c1">## Sets self.highlatA and self.highlatlat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span> <span class="o">=</span> <span class="mf">.10</span><span class="p">;</span> <span class="c1"># This is the hb[10] value from LOSCAR, % seafloor area in high latitude box.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatA</span> <span class="o">=</span> <span class="n">calculateHighLatA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatP</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

            <span class="c1">## Define global distribution of sea seafloor depths</span>
            <span class="c1">## Both self.bathymetryAreaDist and self.bathymetryAreaDist_wHighlat</span>
            <span class="c1">## are define here.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span> <span class="o">=</span> <span class="n">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;RK2021&quot;</span><span class="p">:</span>
                <span class="c1"># 9. Save bathymetry model w/o the ocean volume corrections</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">();</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;EarthRecon3BasinsRK2021_&quot;</span><span class="o">+</span><span class="p">(</span><span class="s2">&quot;H_</span><span class="si">{:2.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>

                <span class="c1">## Create directory for storing bathymetry models</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">create_file_structure</span><span class="p">(</span><span class="n">list_of_directories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/bathymetries/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">saveBathymetry</span><span class="p">(</span><span class="n">reconAge</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

                <span class="c1"># 10. Find basins (Note that this is a partially manual process)</span>
                <span class="c1">## Define basins class for finding basins</span>
                <span class="n">basins</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Basins</span><span class="p">(</span><span class="n">dataDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/bathymetries/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
                                    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">deg_</span><span class="si">{}</span><span class="s2">Ma.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">reconAge</span><span class="p">),</span>
                                    <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">);</span>

                <span class="c1"># Define basins based on user input boundaries</span>
                <span class="c1"># If the file exist then read file, otherwise write</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basins</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">basins</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span><span class="s2">&quot;_basinNetwork.gml&quot;</span><span class="p">))):</span>
                    <span class="n">basins</span><span class="o">.</span><span class="n">defineBasins</span><span class="p">(</span><span class="n">minBasinCnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;Louvain&quot;</span><span class="p">,</span>
                                        <span class="n">reducedRes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;factor&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
                                        <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">basins</span><span class="o">.</span><span class="n">defineBasins</span><span class="p">(</span><span class="n">minBasinCnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;Louvain&quot;</span><span class="p">,</span>
                                        <span class="n">reducedRes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;factor&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
                                        <span class="n">read</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="n">basins</span><span class="o">.</span><span class="n">applyMergeBasinMethods</span><span class="p">(</span><span class="n">reconAge</span><span class="p">,</span>
                                                <span class="n">utils</span><span class="o">.</span><span class="n">mergerPackages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
                                                <span class="n">maxBasinCnt</span><span class="o">=</span><span class="n">maxBasinCnt</span><span class="p">);</span>

                
                <span class="c1"># Assign basins as a BathyRecon class attribute.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basins</span> <span class="o">=</span> <span class="n">basins</span><span class="p">;</span>
                        

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CM2009&quot;</span><span class="p">:</span>
                <span class="c1"># 9. Save bathymetry model w/o the ocean volume corrections</span>
                <span class="c1"># FIXME: Could to define this at a higher level.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">();</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;EarthRecon3Basins&quot;</span>
                <span class="c1">#self.model = &quot;EarthRecon3_4Basins&quot;</span>

                <span class="c1">## Create directory for storing bathymetry models</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">create_file_structure</span><span class="p">(</span><span class="n">list_of_directories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/bathymetries/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">saveBathymetry</span><span class="p">(</span><span class="n">reconAge</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>


                <span class="c1"># 10. Find basins (Note that this is a partially manual process)</span>
                <span class="c1">## Define basins class for finding basins</span>
                <span class="n">basins</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Basins</span><span class="p">(</span><span class="n">dataDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/bathymetries/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
                                    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">deg_</span><span class="si">{}</span><span class="s2">Ma.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">reconAge</span><span class="p">),</span>
                                    <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">);</span>

                <span class="c1"># Define basins based on user input boundaries</span>
                <span class="c1"># If the file exist then read file, otherwise write</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basins</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">basins</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span><span class="s2">&quot;_basinNetwork.gml&quot;</span><span class="p">))):</span>
                    <span class="n">basins</span><span class="o">.</span><span class="n">defineBasins</span><span class="p">(</span><span class="n">minBasinCnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;Louvain&quot;</span><span class="p">,</span>
                                        <span class="n">reducedRes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;factor&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
                                        <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">basins</span><span class="o">.</span><span class="n">defineBasins</span><span class="p">(</span><span class="n">minBasinCnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;Louvain&quot;</span><span class="p">,</span>
                                        <span class="n">reducedRes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;factor&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
                                        <span class="n">read</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">basins</span><span class="o">.</span><span class="n">applyMergeBasinMethods</span><span class="p">(</span><span class="n">reconAge</span><span class="p">,</span>
                                                  <span class="n">utils</span><span class="o">.</span><span class="n">mergerPackages</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermalSubMethod</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])),</span>
                                                  <span class="n">maxBasinCnt</span><span class="o">=</span><span class="n">maxBasinCnt</span><span class="p">);</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="c1"># Assign basins as a BathyRecon class attribute.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basins</span> <span class="o">=</span> <span class="n">basins</span><span class="p">;</span>
                <span class="k">if</span> <span class="n">findBasins</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span><span class="p">;</span>

                <span class="c1"># 11. Apply ocean volume correction based on is representation of present-day</span>
                <span class="c1"># bathymetry.</span>
                <span class="c1"># 11a. Set the ocean volume expected at the reconstruction period.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VOCTarget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVOCi</span><span class="p">(</span><span class="n">reconAge</span><span class="p">);</span>

                <span class="c1"># 11b. Apply the ocean volume correction based on the misfit of present-day</span>
                <span class="c1"># distributions and the expected paleo ocean volume.            </span>
                <span class="k">if</span> <span class="n">reconAge</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sxbin_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addVOCCorrection</span><span class="p">(</span><span class="n">reconAge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOCTarget</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># If self.etopoKernelDis was defined (i.e., the present-day analysis was previously done) then</span>
                        <span class="c1"># the volume correction will be applied to the topography model.</span>
                        

                        <span class="c1"># Apply the ocean volume correction</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sxbin_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addVOCCorrection</span><span class="p">(</span><span class="n">reconAge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOCTarget</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># Present-day analysis was never done, so self.etopoKernelDis is not defined and will not be applied.</span>
                        <span class="k">pass</span>
                
                <span class="c1"># 11c. Assign the VOC corrected bathymetry to the basins object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">bathymetry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">;</span>
            

            <span class="c1"># 12. Save bathymetry model (w/ the ocean volume corrections) in standardized ExoCcycle outputs.</span>

            <span class="c1"># 12a. Calculate basin bathymetry parameters</span>
            <span class="c1"># Note: the basin bathymetry distributions will be calculated</span>
            <span class="c1"># with volume corrected bathymetry since self.basins.bathymetry</span>
            <span class="c1"># was updated with the ocean basin volume corrected bathymetry.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">calculateBasinParameters</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 12b. Calculate basin connectivity parameters</span>
            <span class="c1"># Note: the ocean basin volume correction is applied but basin</span>
            <span class="c1"># connectivity parameters are calculated with the original</span>
            <span class="c1"># (non-VOC corrected) bathymetry. Therefore, there will be some</span>
            <span class="c1"># inconsistencies between basin connectivity parameters and</span>
            <span class="c1"># bathymetry distributions.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">calculateBasinConnectivityParameters</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 12c. Expand original bathymetry netCDF4 file by writting a new basin bathymetry</span>
            <span class="c1"># netCDF4 file that also contains basin bathymetry parameters.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">saveCcycleParameter</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

            <span class="c1"># Report</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">blues_cm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resampled</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span> <span class="o">=</span> <span class="mi">90</span>
                <span class="n">plotHelper</span><span class="o">.</span><span class="n">plotGlobalwHist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span><span class="p">,</span>
                                     <span class="n">outputDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                                     <span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;plotGlobal-Test.png&quot;</span><span class="p">,</span>
                                     <span class="n">cmapOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cmap&quot;</span><span class="p">:</span><span class="n">blues_cm</span><span class="p">,</span>
                                               <span class="s2">&quot;cbar-title&quot;</span><span class="p">:</span><span class="s2">&quot;cbar-title&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;cbar-range&quot;</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">)),</span>
                                                              <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">)]},</span>
                                     <span class="n">pltOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;valueType&quot;</span><span class="p">:</span> <span class="s2">&quot;Bathymetry&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;valueUnits&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;plotTitle&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;plotZeroContour&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">},</span>
                                     <span class="n">saveSVG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">savePNG</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

            
<div class="viewcode-block" id="BathyRecon.getVOCi">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.getVOCi">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getVOCi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the target global ocean-container volume (VOC) at a given age.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        age : int</span>
<span class="sd">            Time (Ma) for which to return VOC.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Target ocean basin volume at `age` (m³). If a constant VOC is used,</span>
<span class="sd">            returns a scalar independent of age.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCValues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOCValues</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOCValues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">VOCAgeValues</span> <span class="o">==</span> <span class="n">age</span><span class="p">];</span></div>


<div class="viewcode-block" id="BathyRecon.saveBathymetry">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.saveBathymetry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">saveBathymetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconAge</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the (optionally VOC-corrected) bathymetry and diagnostics to NetCDF.</span>

<span class="sd">        File layout</span>
<span class="sd">        -----------</span>
<span class="sd">        Dimensions:</span>
<span class="sd">            lat (deg)   : [-90, 90]</span>
<span class="sd">            lon (deg)   : [-180, 180]</span>
<span class="sd">            binEdges    : upper bound edges (km) for depth bins</span>

<span class="sd">        Variables:</span>
<span class="sd">            bathymetry(lat,lon)                           : m (positive depth; land=NaN)</span>
<span class="sd">            lat(lat), lon(lon)                            : deg</span>
<span class="sd">            areaWeights(lat)                              : m² (per-lat row representative)</span>
<span class="sd">            binEdges(binEdges)                            : km</span>
<span class="sd">            bathymetry-distribution-G(binEdges)           : % area (kernel)</span>
<span class="sd">            bathymetry-distribution-whighlat-G(binEdges)  : % area (kernel; incl. high-lat)</span>
<span class="sd">            highlatlat                                    : deg</span>
<span class="sd">            highlatA                                      : m²</span>
<span class="sd">            AOC                                           : m²</span>
<span class="sd">            VOC                                           : m³</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reconAge : int</span>
<span class="sd">            Reconstruction age (Ma) to encode in filename.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, ensures directories exist and prints path.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make directory for storing bathymetry model(s)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_file_structure</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries/EarthRecon&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries/EarthRecon3Basins&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/bathymetries/EarthRecon3_4Basins&quot;</span><span class="p">],</span>
                                     <span class="n">root</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>     
        
        <span class="c1"># Set netCDF4 filename</span>
        <span class="n">BathyPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/bathymetries/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2:0.0f}</span><span class="s2">deg_</span><span class="si">{3:0.0f}</span><span class="s2">Ma.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">reconAge</span><span class="p">);</span>
        
        <span class="c1"># Make new .nc file</span>
        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">BathyPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span> 

        <span class="c1"># Define dimension (latitude, longitude, and bathymetry distributions)</span>
        <span class="n">lat_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]));</span>     <span class="c1"># latitude axis</span>
        <span class="n">lon_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]));</span>     <span class="c1"># longitude axis</span>
        <span class="n">binEdges_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]));</span>      <span class="c1"># distribution</span>
        
        <span class="c1"># Define lat/lon with the same names as dimensions to make variables.</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,));</span>
        <span class="n">lat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span><span class="p">;</span> <span class="n">lat</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">;</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,));</span>
        <span class="n">lon</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span><span class="p">;</span> <span class="n">lon</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">;</span>

        <span class="c1"># Define a 2D variable to hold the elevation data</span>
        <span class="n">bathy</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;bathymetry&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">))</span>
        <span class="n">bathy</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
        <span class="n">bathy</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;bathymetry&#39;</span>

        <span class="c1"># Define vector as function with longitude dependence</span>
        <span class="n">areaWeights</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;areaWeights&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,(</span><span class="s1">&#39;lat&#39;</span><span class="p">,))</span>
        <span class="n">areaWeights</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters sq&#39;</span>
        <span class="n">areaWeights</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;areaWeights&#39;</span>

        <span class="c1"># Define variables for bathymetry distributions (vectors)</span>
        <span class="n">binEdges</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,));</span>
        <span class="n">binEdges</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span><span class="p">;</span> <span class="n">binEdges</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;km depth&#39;</span><span class="p">;</span>

        <span class="n">distribution_whighlat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;bathymetry-distribution-whighlat-G&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,))</span>
        <span class="n">distribution_whighlat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;kernel distribution&#39;</span>
        <span class="n">distribution_whighlat</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;bathymetry-distribution-whighlat-G&#39;</span>

        <span class="n">distribution</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;bathymetry-distribution-G&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;binEdges&#39;</span><span class="p">,))</span>
        <span class="n">distribution</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;kernel distribution&#39;</span>
        <span class="n">distribution</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;bathymetry-distribution-G&#39;</span>

        <span class="c1"># Define single values parameters (e.g., VOC, AOC, high latitude cutoff)</span>
        <span class="n">highlatlat</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;highlatlat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">highlatlat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees&#39;</span>
        <span class="n">highlatlat</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;highlatlat&#39;</span>

        <span class="n">highlatA</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;highlatA&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">highlatA</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters sq&#39;</span>
        <span class="n">highlatA</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;highlatA&#39;</span>

        <span class="n">VOC</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;VOC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">VOC</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters cubed&#39;</span>
        <span class="n">VOC</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;VOC&#39;</span>

        <span class="n">AOC</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;AOC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">AOC</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;meters sq&#39;</span>
        <span class="n">AOC</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;AOC&#39;</span>
        
        <span class="c1"># Format title</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Bathymetry created from topography resampled at </span><span class="si">{:0.0f}</span><span class="s1"> degrees.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>

        <span class="c1"># Populate the variables</span>
        <span class="n">lat</span><span class="p">[:]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">lon</span><span class="p">[:]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:];</span>
        <span class="n">bathy</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry</span><span class="p">;</span>
        <span class="n">areaWeights</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>

        <span class="c1"># Add bathymetry distribution information</span>
        <span class="n">distribution_whighlat</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">;</span>
        <span class="n">distribution</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="p">;</span>
        <span class="n">binEdges</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:];</span>

        <span class="c1"># Add attributes</span>
        <span class="n">highlatlat</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatlat</span><span class="p">;</span>
        <span class="n">highlatA</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlatA</span><span class="p">;</span>
        <span class="n">VOC</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOC</span><span class="p">;</span>
        <span class="n">AOC</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AOC</span><span class="p">;</span>

        <span class="c1"># Close the netcdf</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>


<div class="viewcode-block" id="BathyRecon.getDEM">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.getDEM">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getDEM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">fuzzyAge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a paleoDEM for the requested time and resample to the target grid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        age : int</span>
<span class="sd">            Target reconstruction age (Ma).</span>
<span class="sd">        resolution : float</span>
<span class="sd">            Output grid spacing (degrees).</span>
<span class="sd">        fuzzyAge : bool, optional</span>
<span class="sd">            If True, allows nearest match within small tolerance (±0.5 Myr).</span>

<span class="sd">        Defines</span>
<span class="sd">        -------</span>
<span class="sd">        self.paleoDEM : netCDF4.Dataset</span>
<span class="sd">            Temporary NetCDF with resampled paleoDEM (`z` variable).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Uses `gmt grdsample` to resample and convert to cell-registered grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the paleoDEM file most closely related to the</span>
        <span class="c1"># reconstruction period.</span>
        <span class="n">paleoDEMfidi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="s1">&#39;paleoDEMs&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">paleoDEMsfids</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paleoDEMsAges</span> <span class="o">-</span> <span class="n">age</span><span class="p">))</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paleoDEMsAges</span> <span class="o">-</span> <span class="n">age</span><span class="p">)</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Use gmt to copy the paleoDEM, resampling into the user</span>
        <span class="c1"># defined resolution. Note that this code also converts</span>
        <span class="c1"># the paleoDEM from grid line to cell registered.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdsample </span><span class="si">{0}</span><span class="s2"> -G</span><span class="si">{1}</span><span class="s2"> -I</span><span class="si">{2}</span><span class="s2"> -Rd -T -Vq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paleoDEMfidi</span><span class="p">,</span>
                                                                <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempPaleoDEMi.nc&#39;</span><span class="p">,</span>
                                                                <span class="n">resolution</span><span class="p">))</span>
        
        <span class="c1"># Read paleoDEM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paleoDEM</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempPaleoDEMi.nc&#39;</span><span class="p">);</span>

        <span class="c1"># Delete paleoDEM</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempPaleoDEMi.nc&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="BathyRecon.getOceanLithosphereAgeGrid">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.getOceanLithosphereAgeGrid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getOceanLithosphereAgeGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">fuzzyAge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an ocean lithosphere age grid nearest to the requested time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        age : int</span>
<span class="sd">            Target reconstruction age (Ma).</span>
<span class="sd">        resolution : float</span>
<span class="sd">            Output grid spacing (degrees).</span>
<span class="sd">        fuzzyAge : bool, optional</span>
<span class="sd">            If True, allows nearest match within small tolerance.</span>

<span class="sd">        Defines</span>
<span class="sd">        -------</span>
<span class="sd">        self.oceanLithAge : netCDF4.Dataset</span>
<span class="sd">            Temporary NetCDF with resampled lithosphere ages (`z` variable),</span>
<span class="sd">            plus `lat`/`lon` axes.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Uses `gmt grdsample` to resample and convert to cell-registered grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the paleoDEM file most closely related to the</span>
        <span class="c1"># reconstruction period.</span>
        <span class="n">oceanLithAgefidi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="s1">&#39;oceanLith&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">oceanLithfids</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oceanLithReconAges</span> <span class="o">-</span> <span class="n">age</span><span class="p">))</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oceanLithReconAges</span> <span class="o">-</span> <span class="n">age</span><span class="p">)</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Use gmt to copy the paleoDEM, resampling into the user</span>
        <span class="c1"># defined resolution. Note that this code also converts</span>
        <span class="c1"># the paleoDEM from grid line to cell registered.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdsample </span><span class="si">{0}</span><span class="s2"> -G</span><span class="si">{1}</span><span class="s2"> -I</span><span class="si">{2}</span><span class="s2"> -Rd -T -Vq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oceanLithAgefidi</span><span class="p">,</span>
                                                                <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempOecanLithAgei.nc&#39;</span><span class="p">,</span>
                                                                <span class="n">resolution</span><span class="p">))</span>
        
        <span class="c1"># Read paleoDEM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempOecanLithAgei.nc&#39;</span><span class="p">);</span>

        <span class="c1"># Delete paleoDEM</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempOecanLithAgei.nc&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="BathyRecon.addThermalSub">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.addThermalSub">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">addThermalSub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topography</span><span class="p">,</span> <span class="n">seafloorAge</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CM2009&#39;</span><span class="p">},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply thermal subsidence to an oceanic lithosphere surface using empirical</span>
<span class="sd">        or parameterized age–depth relationships.</span>

<span class="sd">        The function computes first-order bathymetric depth as a function of</span>
<span class="sd">        seafloor age, representing the thermal contraction of the lithosphere</span>
<span class="sd">        during conductive and convective cooling phases. The resulting depth field</span>
<span class="sd">        is superimposed onto the existing topography array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topography : numpy.ndarray</span>
<span class="sd">            2-D array of surface elevation or base topography (m). Values at</span>
<span class="sd">            oceanic locations will be overwritten by predicted oceanic depth.</span>
<span class="sd">        seafloorAge : numpy.ndarray</span>
<span class="sd">            2-D grid of seafloor ages (Myr). NaN where non-oceanic.</span>
<span class="sd">        latitude : numpy.ndarray</span>
<span class="sd">            2-D grid of latitudes (degrees), corresponding to `seafloorAge`.</span>
<span class="sd">        method : dict, optional</span>
<span class="sd">            Dictionary defining the thermal subsidence scheme. Defaults to</span>
<span class="sd">            ``{&#39;type&#39;: &#39;CM2009&#39;}``. Accepted values are listed in *Notes*.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, prints debug information or diagnostic comparisons.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Updated 2-D array of bathymetric depth (m) representing the thermal</span>
<span class="sd">            subsidence of the oceanic lithosphere.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        **Available Methods**</span>
<span class="sd">            - ``&#39;CM2009&#39;`` — Crosby &amp; McKenzie (2009):  </span>
<span class="sd">            Empirical piecewise relation between seafloor age and depth.  </span>
<span class="sd">            - ``&#39;RK2021&#39;`` — Rosas &amp; Korenaga (2021):  </span>
<span class="sd">            Physically parameterized model with variable internal heating (H)</span>
<span class="sd">            and mid-ocean ridge depth.</span>

<span class="sd">        **Parameters used for RK2021 calculations**</span>

<span class="sd">            a1      = 0.001      (Slope, conductive phase [1/Myr^0.5]),  </span>
<span class="sd">            a2      = 0.0228     (Slope, convective phase [-]),  </span>
<span class="sd">            b2      = 0.0452     (Intercept, conductive phase [-]),  </span>
<span class="sd">            tmax    = 500        (Maximum seafloor age [Myr]),  </span>
<span class="sd">            ti      = 2.5        (Axis intercept (Fig. 2a RK2021) [Myr]),  </span>
<span class="sd">            rhoW    = 1000       (Water density [kg/m^3]),  </span>
<span class="sd">            rhoM    = 3300       (Surface mantle density [kg/m^3]),  </span>
<span class="sd">            rho0    = 4000       (Reference mantle density [kg/m^3]),  </span>
<span class="sd">            d       = 2.9e6      (Mantle thickness [m]),  </span>
<span class="sd">            kappa   = 4          (Thermal conductivity [W/m/K]),  </span>
<span class="sd">            alpha   = 1e-6       (Thermal expansivity [1/K]),  </span>
<span class="sd">            deltaT  = 1350       (Mantle potential temperature [K]),  </span>
<span class="sd">            nu0     = 1.3e20     (Reference viscosity [Pa·s]  </span>

<span class="sd">        **Varying Parameters (from RK2021, Fig. 2a)**</span>

<span class="sd">            H* — Non-dimensionalized internal heating parameter (varies)  </span>
<span class="sd">            t* — Onset time of asthenospheric convection (varies)</span>

<span class="sd">        These values may be digitized or interpolated from Rosas &amp; Korenaga (2021)</span>
<span class="sd">        to reconstruct the age–depth relation for specific internal heating regimes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">method</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;RK2021&quot;</span><span class="p">:</span>
            <span class="c1"># Rosas and Korenaga (2021) age-depth relationship for different internal</span>
            <span class="c1"># heating scenarios.</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="c1"># Conversion</span>
            <span class="n">Myr2s</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e6</span><span class="p">)</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span> <span class="c1"># [s/Myr]</span>

            <span class="c1"># All parameters are taken from Rosas and Korenaga (2021)</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">;</span>           <span class="c1"># Slope for linear relation between H* in the conductive phase [1/s^(1/2)]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0228</span><span class="p">;</span>          <span class="c1"># Slope for linear relation between H* in the convection phase [-]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0452</span><span class="p">;</span>          <span class="c1"># Intercept for linear relation between H* in the conductive phase [-]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span><span class="o">*</span><span class="n">Myr2s</span><span class="p">;</span>     <span class="c1"># Maximum age of seafloor [s]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;ti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.5</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Myr2s</span><span class="p">;</span>  <span class="c1"># Intersection with horizontal axis (ext fig 2a) [s]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;rhoW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>          <span class="c1"># Surface mantle density [kg/m3]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;rhoM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3300</span><span class="p">;</span>          <span class="c1"># Density of water [kg/m3]</span>

            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;rho0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>          <span class="c1"># Reference density [kg/m3]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2900e3</span><span class="p">;</span>           <span class="c1"># Thickness of manle [m]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                <span class="c1"># Thermal conductivity [W/m/K]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;kappa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>         <span class="c1"># Thermal diffusivity [m2/s]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3e-5</span><span class="p">;</span>         <span class="c1"># Thermal expansivity [1/K]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;deltaT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1350</span><span class="p">;</span>        <span class="c1"># Mantle potential temperature [K]</span>

            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;nu0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.3e20</span><span class="p">;</span>         <span class="c1"># Asthenospheric viscosity [Pa s]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">,</span> <span class="mf">4.8</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="mf">1e-12</span><span class="p">;</span> <span class="c1"># Internal heating [W/m/K]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;Hstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;rho0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;deltaT&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;H&#39;</span><span class="p">];</span>

            <span class="c1"># Digitized from figure 2a (Rosas and Korenaga 2021)</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;tstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">16.966824644549764</span><span class="p">,</span>
                                                    <span class="mf">16.303317535545023</span><span class="p">,</span>
                                                    <span class="mf">15.734597156398102</span><span class="p">,</span>
                                                    <span class="mf">15.165876777251183</span><span class="p">,</span>
                                                    <span class="mf">14.786729857819903</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Myr2s</span><span class="p">;</span> <span class="c1"># Onset time pf sublithospheric of convection[s]</span>


            <span class="c1"># Functions for seafloor subsidence from Rosas and Korenaga (2021)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">whs</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">deltaT</span><span class="p">,</span> <span class="n">rhoM</span><span class="p">,</span> <span class="n">rhoW</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                Function for seafloor subsidence (i.e., cooling of a semi-infinite 2D halfspace from RK2021)</span>
<span class="sd">                </span>
<span class="sd">                Parameters</span>
<span class="sd">                -----------</span>
<span class="sd">                alpha : FLOAT</span>
<span class="sd">                    Thermal expansivity, in [1/K].</span>
<span class="sd">                deltaT : FLOAT</span>
<span class="sd">                    Mantle potential temperature, in [K].</span>
<span class="sd">                rhoM : FLOAT</span>
<span class="sd">                    Surface mantle density density, in kg/m3.</span>
<span class="sd">                rhoW : FLOAT</span>
<span class="sd">                    Water density, in kg/m3.</span>
<span class="sd">                kappa :</span>
<span class="sd">                    Thermal diffusivity, in [m2/s].</span>
<span class="sd">                age : NUMPY ARRAY</span>
<span class="sd">                    Seafloor age, in [s].</span>

<span class="sd">                Return</span>
<span class="sd">                -------</span>
<span class="sd">                Depth of seafloor with respect to a mid-ocean-ridge depth, in m. </span>

<span class="sd">                &#39;&#39;&#39;</span>
                <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">deltaT</span><span class="o">*</span><span class="p">(</span> <span class="n">rhoM</span> <span class="o">/</span> <span class="p">(</span><span class="n">rhoM</span><span class="o">-</span><span class="n">rhoW</span><span class="p">)</span> <span class="p">))</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">age</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">ws</span><span class="p">(</span><span class="n">whs</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">tstar</span><span class="p">,</span> <span class="n">Hstar</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                Function for correction of seafloor subsidence (i.e., cooling of a</span>
<span class="sd">                semi-infinite 2D halfspace from RK2021) when mantle internal heating</span>
<span class="sd">                changes with respect to present-day.</span>
<span class="sd">                </span>
<span class="sd">                Parameters</span>
<span class="sd">                -----------</span>
<span class="sd">                whs : NUMPY ARRAY</span>
<span class="sd">                    Depth of seafloor with respect to a mid-ocean-ridge depth and</span>
<span class="sd">                    as calculated from whs (RK2021), in [m].</span>
<span class="sd">                a1 : FLOAT</span>
<span class="sd">                    Slope for linear relation between H* in the conductive phase,</span>
<span class="sd">                    in [1/Myr^(1/2)].</span>
<span class="sd">                a2 : FLOAT</span>
<span class="sd">                    Slope for linear relation between H* in the convection phase,</span>
<span class="sd">                    in [-].</span>
<span class="sd">                b2 : FLOAT</span>
<span class="sd">                    Intercept for linear relation between H* in the conductive</span>
<span class="sd">                    phase, in [-].</span>
<span class="sd">                ti : FLOAT</span>
<span class="sd">                    Intersection with horizontal axis (ext fig 2a), in [Myr].</span>
<span class="sd">                tmax : FLOAT</span>
<span class="sd">                    Maximum age of seafloor, in [Myr].</span>
<span class="sd">                tstar : FLOAT</span>
<span class="sd">                    Onset of asthenospheric convection, in [Myr].</span>
<span class="sd">                Hstar : FLOAT</span>
<span class="sd">                    Non-dimensionalized internal heating, in [-].</span>
<span class="sd">                age : NUMPY ARRAY</span>
<span class="sd">                    Seafloor age, in [Myr].</span>

<span class="sd">                Return</span>
<span class="sd">                -------</span>
<span class="sd">                Depth of seafloor with respect to a mid-ocean-ridge depth, in m. </span>

<span class="sd">                &#39;&#39;&#39;</span>
                <span class="c1"># Conductive dominated</span>
                <span class="n">whs</span><span class="p">[</span><span class="n">age</span><span class="o">&lt;</span><span class="n">tstar</span><span class="p">]</span> <span class="o">=</span> <span class="n">whs</span><span class="p">[</span><span class="n">age</span><span class="o">&lt;</span><span class="n">tstar</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">Hstar</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">age</span><span class="p">[</span><span class="n">age</span><span class="o">&lt;</span><span class="n">tstar</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span> <span class="p">)</span>
                <span class="c1"># Convection dominated</span>
                <span class="n">whs</span><span class="p">[</span><span class="n">age</span><span class="o">&gt;=</span><span class="n">tstar</span><span class="p">]</span>  <span class="o">=</span> <span class="n">whs</span><span class="p">[</span><span class="n">age</span><span class="o">&gt;=</span><span class="n">tstar</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">Hstar</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tstar</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span> <span class="o">+</span>\
                                                <span class="p">(</span><span class="n">Hstar</span><span class="o">*</span><span class="p">(</span><span class="n">a1</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tstar</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span><span class="o">-</span><span class="n">b2</span><span class="p">)</span><span class="o">*</span>\
                                                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">age</span><span class="p">[</span><span class="n">age</span><span class="o">&gt;=</span><span class="n">tstar</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tstar</span><span class="p">))</span><span class="o">/</span>\
                                                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tstar</span><span class="p">)))</span>
                <span class="k">return</span> <span class="n">whs</span>
            
            <span class="c1"># Determine the onset of asthenospheric convection from</span>
            <span class="c1"># the input internal heating.</span>
            <span class="c1">## Find the closest H value from the RK2021 paper</span>
            <span class="c1">## Find the index of that internal heating value</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Calculate cooling from a semi-infinite 2D half-space</span>
            <span class="n">whsi</span> <span class="o">=</span> <span class="n">whs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                       <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;deltaT&#39;</span><span class="p">],</span>
                       <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;rhoM&#39;</span><span class="p">],</span>
                       <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;rhoW&#39;</span><span class="p">],</span>
                       <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;kappa&#39;</span><span class="p">],</span>
                       <span class="n">seafloorAge</span><span class="o">*</span><span class="n">Myr2s</span><span class="p">)</span>
            
            <span class="c1"># Apply the correction terms to whsi for internal conditions</span>
            <span class="c1"># and add the depth of the MOR.</span>
            <span class="n">wsi</span>  <span class="o">=</span> <span class="n">ws</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">whsi</span><span class="p">),</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;a1&#39;</span><span class="p">],</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;a2&#39;</span><span class="p">],</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;b2&#39;</span><span class="p">],</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;ti&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Myr2s</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Myr2s</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;tstar&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">Myr2s</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">][</span><span class="s1">&#39;Hstar&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">seafloorAge</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1e3</span><span class="p">)</span><span class="o">*</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;MORDepthkm&#39;</span><span class="p">];</span>
        
            <span class="c1"># Set seafloor area with no seafloor ages to nan.</span>
            <span class="n">wsi</span><span class="p">[</span><span class="n">seafloorAge</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">;</span>
            <span class="n">wsi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">)]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># Modify the input topography with thermal subsidence calculations.</span>
            <span class="n">topography</span> <span class="o">=</span> <span class="n">wsi</span><span class="p">;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Crosby and Mckenzie (2009) age-depth relationship piecewise logicals</span>
            <span class="n">age_eq_less_than_75</span><span class="o">=</span><span class="p">(</span><span class="n">seafloorAge</span><span class="o">&lt;=</span><span class="mi">75</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">seafloorAge</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">age_eq_less_than_160</span><span class="o">=</span><span class="p">(</span><span class="n">seafloorAge</span><span class="o">&lt;=</span><span class="mi">160</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">seafloorAge</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">)</span>
            <span class="n">age_greater_than_160</span><span class="o">=</span><span class="n">seafloorAge</span><span class="o">&gt;</span><span class="mi">160</span>

            <span class="c1"># Convert age to depth using Crosby and Mckenzie (2009) age-depth</span>
            <span class="c1"># relationship for oceanic crust</span>
            <span class="n">depth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seafloorAge</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">age_eq_less_than_75</span><span class="p">]</span><span class="o">=</span><span class="mi">2652</span><span class="o">+</span><span class="mi">324</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">[</span><span class="n">age_eq_less_than_75</span><span class="p">])</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">age_eq_less_than_160</span><span class="p">]</span><span class="o">=</span><span class="mi">5028</span><span class="o">+</span><span class="mf">5.26</span><span class="o">*</span><span class="n">seafloorAge</span><span class="p">[</span><span class="n">age_eq_less_than_160</span><span class="p">]</span><span class="o">-</span><span class="mi">250</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">seafloorAge</span><span class="p">[</span><span class="n">age_eq_less_than_160</span><span class="p">]</span><span class="o">-</span><span class="mi">75</span><span class="p">)</span><span class="o">/</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">age_greater_than_160</span><span class="p">]</span><span class="o">=</span><span class="mi">5750</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">seafloorAge</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">)]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># Modify the input topography with thermal subsidence calculations.</span>
            <span class="n">topography</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
        
        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------seafloorAge&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">seafloorAge</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------depth&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------topography&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">topography</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">topography</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">topography</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="c1">## Return depth</span>
        <span class="k">return</span> <span class="n">topography</span></div>


<div class="viewcode-block" id="BathyRecon.getESL">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.getESL">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getESL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topography</span><span class="p">,</span> <span class="n">seafloorAge</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply eustatic sea-level offset (Haq87) to oceanic regions only.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topography : numpy.ndarray</span>
<span class="sd">            2-D topography with oceanic depths (m; positive).</span>
<span class="sd">        seafloorAge : numpy.ndarray</span>
<span class="sd">            2-D seafloor age grid (Myr); NaN over continents/paleoDEM areas.</span>
<span class="sd">        age : float</span>
<span class="sd">            Time (Ma) for which to sample the Haq87 sea-level curve.</span>
<span class="sd">        factor : float, optional</span>
<span class="sd">            Fraction of the Haq87 value to apply (0–1). Default 1.0.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, prints the applied offset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (numpy.ndarray, float)</span>
<span class="sd">            Tuple of (modified topography, applied ESL in meters).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Resolution of input (read) eustatic sealevel curve, in myr.</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="mf">.09</span><span class="p">;</span>
        
        <span class="c1">## Apply Haq-87 sea-level curve to ocean regions only (Haq_87_SL_temp=0 if opt_Haq87_SL==False)</span>
        <span class="c1"># Inceased sea level is added to depth since depth is positive</span>
        <span class="n">Haq_87_SL_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ESL</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESL</span><span class="p">[</span><span class="s1">&#39;Ma&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">age</span><span class="p">)</span><span class="o">&lt;</span><span class="n">resolution</span><span class="p">][</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Modify the topography with sealevel</span>
        <span class="c1"># Note that this change in sea-level is only applied over ocean</span>
        <span class="c1"># seafloor modeled with seafloor ages (i.e., seafloor represented</span>
        <span class="c1"># by paleoDEMs is not changed).</span>
        <span class="n">topography</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">)]</span> <span class="o">-=</span> <span class="n">Haq_87_SL_temp</span><span class="o">*</span><span class="n">factor</span><span class="p">;</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The eustatic sea-level at </span><span class="si">{0:.0f}</span><span class="s2"> Ma with respect to present-day is </span><span class="si">{1:0.1f}</span><span class="s2"> m.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">Haq_87_SL_temp</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">topography</span><span class="p">,</span> <span class="n">Haq_87_SL_temp</span>  </div>


<div class="viewcode-block" id="BathyRecon.getSed">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.getSed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getSed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seafloorAge</span><span class="p">,</span> <span class="n">latitude</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate deep-marine sediment thickness from age/latitude (Straume et al., 2019).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        seafloorAge : numpy.ndarray</span>
<span class="sd">            2-D seafloor age grid (Myr); NaN where not oceanic.</span>
<span class="sd">        latitude : numpy.ndarray</span>
<span class="sd">            2-D latitude grid (deg).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Sediment thickness (m) computed from a second-order polynomial in</span>
<span class="sd">            latitude modulated by sqrt(age); NaN where seafloorAge is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
        
        <span class="c1">## Calculate sediment thickness w/ Straume et al. (2019) age-sediment thickness relationship</span>
        <span class="n">sedThick</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">);</span>
        <span class="n">sedThick</span><span class="p">[</span><span class="n">seafloorAge</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">;</span>
        <span class="n">sedThick</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">52</span><span class="o">-</span><span class="mf">2.46</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span><span class="o">+</span><span class="mf">0.045</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">latitude</span><span class="p">)));</span>
        
        <span class="k">return</span> <span class="n">sedThick</span></div>


<div class="viewcode-block" id="BathyRecon.getIsostaticCorrection">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.getIsostaticCorrection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getIsostaticCorrection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topography</span><span class="p">,</span> <span class="n">seafloorAge</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add sediment thickness and apply isostatic compensation to oceanic depths.</span>

<span class="sd">        The load of seawater + sediments is compensated following Hoggard et al. (2017)</span>
<span class="sd">        and Athy (1930) porosity decay, yielding a corrected bathymetric depth.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topography : numpy.ndarray</span>
<span class="sd">            2-D bathymetry/topography (m) before sediment/isostatic terms.</span>
<span class="sd">        seafloorAge : numpy.ndarray</span>
<span class="sd">            2-D seafloor age (Myr); NaN over continents.</span>
<span class="sd">        latitude, longitude : numpy.ndarray</span>
<span class="sd">            2-D coordinate grids (deg).</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, plots a quicklook of bathymetry change.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Bathymetry/topography with sediment loading + isostatic correction applied (m).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate sediment thickness</span>
        <span class="n">sedThickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSed</span><span class="p">(</span><span class="n">seafloorAge</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>

        <span class="c1">## Apply Hoggard et al. (2017) isostatic correction using calculated sediment thicknesses</span>
        <span class="c1"># Define densities (Hoggard et al., 2017; Athy, 1930)</span>
        <span class="n">rho_w</span>   <span class="o">=</span> <span class="mf">1.03e3</span><span class="p">;</span>      	<span class="c1"># [Mg/m^3] Density of water (Hoggard et al., 2017)</span>
        <span class="n">rho_a</span>   <span class="o">=</span> <span class="mf">3.20e3</span><span class="p">;</span>       	<span class="c1"># [Mg/m^3] Density of Asthenosphere (Hoggard et al., 2017)</span>
        <span class="n">phi0</span>    <span class="o">=</span> <span class="mf">0.61</span><span class="p">;</span>         	<span class="c1"># [-]  (Athy, 1930)</span>
        <span class="n">lamda</span>   <span class="o">=</span> <span class="mf">3.9e3</span><span class="p">;</span>        	<span class="c1"># [m]  (Athy, 1930)</span>
        <span class="n">rho_sg</span>  <span class="o">=</span> <span class="mf">2.65e3</span><span class="p">;</span>       	<span class="c1"># [Mg/m^3] Density of solid grains (Hoggard et al., 2017)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">isostaticCorrection</span><span class="p">(</span><span class="n">oceanThickness</span><span class="p">,</span> <span class="n">sedThickness</span><span class="p">):</span>
            <span class="n">rho_s</span><span class="o">=</span><span class="n">rho_sg</span> <span class="o">+</span> <span class="p">((</span><span class="n">phi0</span><span class="o">*</span><span class="n">lamda</span><span class="p">)</span><span class="o">/</span><span class="n">oceanThickness</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">rho_w</span><span class="o">-</span><span class="n">rho_sg</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">oceanThickness</span><span class="o">/</span><span class="n">lamda</span><span class="p">));</span>
            <span class="n">compensatedSedPackages</span><span class="o">=</span><span class="p">((</span><span class="n">rho_a</span><span class="o">-</span><span class="n">rho_s</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rho_a</span><span class="o">-</span><span class="n">rho_w</span><span class="p">))</span><span class="o">*</span><span class="n">sedThickness</span><span class="p">;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Check that the output has the correct sign for positive value bathymetry&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">oceanThickness</span><span class="o">-</span><span class="n">compensatedSedPackages</span>
        
        <span class="c1"># Add sediment thickness and correction term to topography</span>
        <span class="n">topographyOut</span> <span class="o">=</span> <span class="n">isostaticCorrection</span><span class="p">(</span><span class="n">topography</span><span class="p">,</span> <span class="n">sedThickness</span><span class="p">);</span>
        

        <span class="c1"># Plot the change in bathymetry resulting from the sediment/isostatic correction</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># Report</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="c1"># Plot lithosphere ages overlain by coastlines from the paleoDEMS.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">topographyOut</span><span class="o">-</span><span class="n">topography</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Change in bathymetry [m]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>


    
        <span class="k">return</span> <span class="n">topographyOut</span></div>


<div class="viewcode-block" id="BathyRecon.addVOCCorrection">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.addVOCCorrection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">addVOCCorrection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">bathymetry</span><span class="p">,</span> <span class="n">VOCTarget</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust bathymetry distributions to match a target global ocean volume (VOC).</span>

<span class="sd">        Concept</span>
<span class="sd">        -------</span>
<span class="sd">        This function ensures that modeled ocean basin volumes remain consistent</span>
<span class="sd">        with a prescribed target VOC across geologic time.</span>

<span class="sd">        - At present-day (`age == 0`), the model computes the depth-binned</span>
<span class="sd">        distribution mismatch between the simulated bathymetry and modern</span>
<span class="sd">        ETOPO data. From this difference, a correction vector (`sxbin_p`)</span>
<span class="sd">        is derived and cached.</span>

<span class="sd">        - For nonzero ages, the bathymetry is redistributed within basins</span>
<span class="sd">        according to `sxbin_p` and each basin’s fractional volume until</span>
<span class="sd">        the desired global VOC is achieved.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        age : int</span>
<span class="sd">            Geological time (Ma).  </span>
<span class="sd">            If 0, compute and store the correction spectrum for reference.</span>
<span class="sd">        bathymetry : numpy.ndarray</span>
<span class="sd">            2-D bathymetry array (m; positive downward).  </span>
<span class="sd">            Land or emergent regions should be represented as NaN.</span>
<span class="sd">        VOCTarget : float</span>
<span class="sd">            Target global ocean volume (m³) to be matched after redistribution.</span>
<span class="sd">        resolution : float</span>
<span class="sd">            Working grid spacing (degrees) used for ETOPO resampling and</span>
<span class="sd">            histogram comparisons.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, generates diagnostic messages and comparison plots.  </span>
<span class="sd">            Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple of numpy.ndarray</span>
<span class="sd">            Updated bathymetry array and the correction spectrum (`sxbin_p`)</span>
<span class="sd">            expressed as percent change per depth bin.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Uses ``self.basins`` to preserve basin boundaries during redistribution.</span>
<span class="sd">        - The correction spectrum (`sxbin_p`) is stored internally when</span>
<span class="sd">        `age == 0` and reused for other ages to maintain continuity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Set the global ocean basin volume for </span>
        <span class="c1">#VOCTarget = self.getVOCi(age);</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">plotFnc</span><span class="p">(</span><span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span> <span class="n">binEdges</span><span class="p">,</span> <span class="n">areaTotal</span><span class="p">,</span> <span class="n">areaTotalEtopo</span><span class="p">,</span> <span class="n">volTotal</span><span class="p">,</span> <span class="n">volTotalEtopo</span><span class="p">,</span> <span class="n">bathymetry</span><span class="p">,</span> <span class="n">etopo</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            plotFnc is used to plot the difference between the model bathymetry</span>
<span class="sd">            and actual present-day bathymetry. Positive values mean the model</span>
<span class="sd">            overrepresents bathymetry at a given depth.</span>

<span class="sd">            &#39;&#39;&#39;</span>
            <span class="c1">## Set up the Mollweide projection</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>  <span class="c1"># 2 rows, 1 column, with the first row 3 times taller</span>

            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Mollweide</span><span class="p">());</span>

            <span class="c1">## Add the plot using pcolormesh</span>
            <span class="n">bathymetryplt</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
            <span class="n">etopoplt</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">etopo</span><span class="p">);</span>
            <span class="n">bathymetryplt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetryplt</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">etopoplt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">etopoplt</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">bathymetryplt</span><span class="p">[</span><span class="n">bathymetryplt</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bathymetryplt</span><span class="p">[</span><span class="n">bathymetryplt</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">bathymetryplt</span><span class="p">[</span><span class="n">bathymetryplt</span><span class="o">!=</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">etopoplt</span><span class="p">[</span><span class="n">etopoplt</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">etopoplt</span><span class="p">[</span><span class="n">etopoplt</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">etopoplt</span><span class="p">[</span><span class="n">etopoplt</span><span class="o">!=</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">bathymetryplt</span><span class="o">-</span><span class="n">etopoplt</span><span class="p">;</span>
            <span class="c1"># 0     Representing bathymetry.</span>
            <span class="c1"># -1    measured bathymetry was not modeled.</span>
            <span class="c1"># 1     bathymetry was modeled where no measured bathymetry exists.</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">difference</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">difference</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">difference</span><span class="p">[</span><span class="n">difference</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdGy&#39;</span><span class="p">);</span>

            <span class="c1">## Add a colorbar</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="p">)</span>  <span class="c1"># Adjust the size of colorbar ticks</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Bathymetry</span><span class="se">\n</span><span class="s1">Missing from Model&#39;</span><span class="p">,</span> <span class="s1">&#39;Bathymetry</span><span class="se">\n</span><span class="s1">Missing from Etopo&#39;</span><span class="p">])</span> 

            <span class="c1">## Add gridlines</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

            <span class="c1">## Set a title</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Earth (Modeled/Measured) Bathymetry&quot;</span><span class="p">)</span>

            <span class="c1">## Make histogram plot</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            
            <span class="n">factor1</span> <span class="o">=</span> <span class="mf">.2</span>
            <span class="n">factor2</span> <span class="o">=</span> <span class="mf">.25</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="p">(</span><span class="n">factor2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">factor1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span> <span class="s2">&quot;Mismatch&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="p">(</span><span class="n">factor2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">bathymetryAreaDist</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">factor1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span> <span class="s2">&quot;Mismatch&quot;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

            <span class="c1"># Plot annoation of total area and volume difference</span>
            <span class="n">deltaAOC</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">areaTotal</span><span class="o">-</span><span class="n">areaTotalEtopo</span><span class="p">)</span><span class="o">/</span><span class="n">areaTotalEtopo</span><span class="p">;</span>
            <span class="n">deltaVOC</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">volTotal</span><span class="o">-</span><span class="n">volTotalEtopo</span><span class="p">)</span><span class="o">/</span><span class="n">volTotalEtopo</span><span class="p">;</span>


            <span class="n">bbox</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;0.9&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;$\Delta$AOC = </span><span class="si">{</span><span class="n">deltaAOC</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">$\Delta$VOC = </span><span class="si">{</span><span class="n">deltaVOC</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">)</span>

            <span class="c1"># ticks</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>

            <span class="c1"># Labels</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;(Modeled - Measured) Bathymetry Distribution&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bathymetry Bins [km]&quot;</span><span class="p">);</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Seafloor Area [%]</span><span class="se">\n</span><span class="s2">Overrepresented in Model&quot;</span><span class="p">);</span>

            <span class="c1"># figure format</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>



        <span class="k">def</span><span class="w"> </span><span class="nf">plotFnc2</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>
                     <span class="n">areaTotal</span><span class="p">,</span> <span class="n">areaTotalEtopo</span><span class="p">,</span> <span class="n">volTotal</span><span class="p">,</span> <span class="n">volTotalEtopo</span><span class="p">,</span>
                            <span class="n">binEdges</span><span class="p">,</span> <span class="n">bathymetryAreaDistVOCcorrection</span><span class="p">,</span> <span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span>
                            <span class="n">outputDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                            <span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;plotGlobal.png&quot;</span><span class="p">,</span>
                            <span class="n">cmapOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cmap&quot;</span><span class="p">:</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cbar-title&quot;</span><span class="p">:</span><span class="s2">&quot;cbar-title&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cbar-range&quot;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]},</span>
                            <span class="n">pltOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;valueType&quot;</span><span class="p">:</span> <span class="s2">&quot;Bathymetry&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;valueUnits&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;plotTitle&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;plotZeroContour&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">},</span>
                            <span class="n">saveSVG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">savePNG</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            plotFnc2 function is used to plot global ranging datasets that</span>
<span class="sd">            are represented with evenly spaced latitude and longitude values.</span>
<span class="sd">            This function is modified from plotGlobalwHist and is used to </span>
<span class="sd">            plot and compare VOC corrected bathymetry vs etopo bathymetry.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            lat : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing cell registered latitudes, in deg,</span>
<span class="sd">                ranging from [-90, 90]. Latitudes change from row to row.</span>
<span class="sd">            lon : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing cell registered longitudes, in deg,</span>
<span class="sd">                ranging from [-180, 180]. Longitudes change from column to column.</span>
<span class="sd">            Values : NUMPY ARRAY</span>
<span class="sd">                nx2n array representing cell registered geographic data, in [-] units.</span>
<span class="sd">            cmapOpts : DICTIONARY</span>
<span class="sd">                A set of options to format the color map and bar for the plot</span>
<span class="sd">            pltOpts : DICTIONARY</span>
<span class="sd">                A set of options to format the plot</span>
<span class="sd">            saveSVG : BOOLEAN</span>
<span class="sd">                An option to save an SVG output. The default is False.</span>
<span class="sd">            savePNG : BOOLEAN</span>
<span class="sd">                An option to save an PNG output. The default is False.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Start making figure</span>
            <span class="c1">## Create a figure</span>
            
            <span class="c1">## Set up the Mollweide projection</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>  <span class="c1"># 2 rows, 1 column, with the first row 3 times taller</span>

            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Mollweide</span><span class="p">());</span>

            <span class="c1">## Add the plot using pcolormesh</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmapOpts</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">cmapOpts</span><span class="p">[</span><span class="s1">&#39;cbar-range&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">cmapOpts</span><span class="p">[</span><span class="s1">&#39;cbar-range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pltOpts</span><span class="p">[</span><span class="s2">&quot;plotZeroContour&quot;</span><span class="p">]:</span>
                <span class="c1"># Set any np.nan values to 0.</span>
                <span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">zeroContour</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

            <span class="c1">## Add a colorbar</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pltOpts</span><span class="p">[</span><span class="s1">&#39;valueType&#39;</span><span class="p">],</span> <span class="n">pltOpts</span><span class="p">[</span><span class="s1">&#39;valueUnits&#39;</span><span class="p">]),</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">);</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Adjust the size of colorbar ticks</span>

            <span class="c1">## Add gridlines</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

            <span class="c1">## Set a title</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">pltOpts</span><span class="p">[</span><span class="s1">&#39;plotTitle&#39;</span><span class="p">])</span>

            <span class="c1">## Make histogram plot</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            
            <span class="n">factor1</span> <span class="o">=</span> <span class="mf">.2</span>
            <span class="n">factor2</span> <span class="o">=</span> <span class="mf">.25</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="p">(</span><span class="n">factor2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">bathymetryAreaDistVOCcorrection</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">factor1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span> <span class="s2">&quot;VOC Corrected bathymetry&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="p">(</span><span class="n">factor2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">factor1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span> <span class="s2">&quot;Etopo Bathymetry&quot;</span><span class="p">)</span>
            

            <span class="c1"># Plot annoation of total area and volume difference</span>
            <span class="n">deltaAOC</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">areaTotal</span><span class="o">-</span><span class="n">areaTotalEtopo</span><span class="p">)</span><span class="o">/</span><span class="n">areaTotalEtopo</span><span class="p">;</span>
            <span class="n">deltaVOC</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">volTotal</span><span class="o">-</span><span class="n">volTotalEtopo</span><span class="p">)</span><span class="o">/</span><span class="n">volTotalEtopo</span><span class="p">;</span>


            <span class="n">bbox</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;0.9&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;$\Delta$AOC = </span><span class="si">{</span><span class="n">deltaAOC</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">$\Delta$VOC = </span><span class="si">{</span><span class="n">deltaVOC</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">)</span>
            
            <span class="c1"># ticks</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>

            <span class="c1"># Labels</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Planet&#39;s Bathymetry Distribution&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bathymetry Bins [km]&quot;</span><span class="p">);</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Seafloor Area [%]&quot;</span><span class="p">);</span>

            <span class="c1"># figure format</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Save figure</span>
            <span class="k">if</span> <span class="n">savePNG</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outputDir</span><span class="p">,</span><span class="n">fidName</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">saveSVG</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outputDir</span><span class="p">,</span><span class="n">fidName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.svg&quot;</span><span class="p">)))</span>
                    

        <span class="c1"># If the bathymetry is representing present day then calculate</span>
        <span class="c1"># the correction distribution to apply to all later paleo</span>
        <span class="c1"># bathymetry reconstructions.</span>
        <span class="k">if</span> <span class="n">age</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Create copy of the measured present-day topography that is</span>
            <span class="c1"># at the same resolution as the reconstruction models.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;gmt grdsample </span><span class="si">{0}</span><span class="s2"> -G</span><span class="si">{1}</span><span class="s2"> -I</span><span class="si">{2}</span><span class="s2"> -Rd -Vq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">etopofid</span><span class="p">,</span>
                                                                    <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempetopo.nc&#39;</span><span class="p">,</span>
                                                                    <span class="n">resolution</span><span class="p">))</span>
            <span class="c1"># Read etopo1 and define etopo bathymetry</span>
            <span class="n">etopo</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempetopo.nc&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">etopo</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span>


            <span class="c1"># Delete paleoDEM</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/tempetopo.nc&#39;</span><span class="p">))</span>

            <span class="c1"># Create bathymetry histogram (for model at 0 Ma)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span> <span class="o">=</span> <span class="n">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

            <span class="c1"># Create bathymetry histogram (for etopo)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span> <span class="o">=</span> <span class="n">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

            <span class="c1"># Mismatch between modeled and measured bathymetry (Positive magitudes represent % of seafloor overrepresented </span>
            <span class="c1"># NORMALIZED TO GLOBAL SEAFLOOR AREA) </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistMismatchGNorm</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">);</span>

            <span class="c1"># Mismatch between modeled and measured bathymetry (Positive magitudes represent % of seafloor overrepresented</span>
            <span class="c1"># NORMALIZED TO MISMATCHED SEAFLOOR AREA)</span>
            <span class="c1">#self.bathymetryAreaDistMismatchMMNorm = 100*self.bathymetryAreaDistMismatchGNorm/np.sum(np.abs(self.bathymetryAreaDistMismatchGNorm));</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">plotFnc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistMismatchGNorm</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistMismatchGNorm</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="p">)]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">),</span>
                        <span class="n">bathymetry</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="p">)</span>
                
            <span class="c1"># Calculate basin parameters. This produces the following useful values</span>
            <span class="c1">## self.basins.BasinIDA : Global array with values corresponding to basin ID</span>
            <span class="c1">## self.basins.bathymetryAreaDistBasin : [&quot;Basin0&quot;, &quot;Basin1&quot;,...].  Note that</span>
            <span class="c1">##      this distribution is calculated with the exclusion of high latitude</span>
            <span class="c1">##      distribution of seafloor depths. This is what is normally inputted into</span>
            <span class="c1">##      the LOSCAR carbon cycle model.</span>
            <span class="c1">## self.basins.bathymetryVolFraction : [&quot;Basin0&quot;, &quot;Basin1&quot;,...]. Each entry contains</span>
            <span class="c1">##      the precent basin volume, normalized to the volume of all ocean basins</span>
            <span class="c1">##      (excluding the high latitude ocean volume).</span>
            <span class="c1">## self.basins.bathymetryAreaFraction : [&quot;Basin0&quot;, &quot;Basin1&quot;,...]. Each entry contains</span>
            <span class="c1">##      the precent basin area, normalized to the total seafloor area (including</span>
            <span class="c1">##      the high latitude area).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">calculateBasinParameters</span><span class="p">()</span>

            <span class="c1"># Apply bathymetry/VOC correction for present-day bathymetry model basin-by-basin</span>
            
            <span class="c1">## Define basin count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="p">)]</span> <span class="p">))</span>

            <span class="c1">## Define basin area and volume fractions</span>
            <span class="n">volBasin</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">);</span>
            <span class="n">areaBasin</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">);</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">):</span>
                <span class="n">areaBasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
                <span class="n">volBasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">bathymetry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
            
            <span class="c1">## Use volume fraction of ocean to determine the fraction of ocean volume correction that should be applied to each basin</span>
            <span class="n">totalVolRes</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">volBasin</span><span class="p">)</span><span class="o">-</span><span class="n">VOCTarget</span><span class="p">)</span>

            <span class="c1">## Total basin volume/area fractions</span>
            <span class="n">volBasinFrac</span> <span class="o">=</span> <span class="n">volBasin</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">volBasin</span><span class="p">);</span>
            
            <span class="c1">## Calculate percents to add to each bin then plot</span>
            <span class="n">sxbin_p</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistEtopo</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">));</span>

            <span class="c1">## Tracks the amount of ocean volume removed</span>
            <span class="n">basinVolumeRemoved</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            
            <span class="c1">## Create logical to represent all values of depth_in in each bin (depthBinLogical)</span>
            <span class="n">randomDepthIndBin</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">):</span>
                 
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>

                    <span class="c1"># Note that depthBinLogical represents an (nx2) array with rows</span>
                    <span class="c1"># representing indecies of points that lie within basini and </span>
                    <span class="c1"># self.binEdges[j] and self.binEdges[j+1] depths.</span>
                    <span class="c1"># Note that self.binEdges values are in units of km.</span>
                    <span class="c1"># Note that bathymetry is positive and in units of m.</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">):</span>      <span class="c1"># Contains depths between current bin and next bin</span>
                        <span class="n">depthBinLogical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">&amp;</span><span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">)</span> <span class="p">);</span>
                    <span class="k">else</span><span class="p">:</span>                        <span class="c1"># The last bin which contains depths below bins_in(end)</span>
                        <span class="n">depthBinLogical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">)</span> <span class="p">);</span>
                    
                    <span class="n">verbose2</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">verbose2</span><span class="p">:</span>
                        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">for</span> <span class="n">pointi</span> <span class="ow">in</span> <span class="n">depthBinLogical</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basin-</span><span class="si">{0}</span><span class="s2">_Bin-</span><span class="si">{1}</span><span class="s2">_to_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">bathymetry</span><span class="p">[</span><span class="n">pointi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pointi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="n">cnt</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Random_depth_ind represents random depths to modify</span>
                    <span class="c1"># This has a very minor effect on bathymetry distributions input</span>
                    <span class="c1"># into LOSCAR.</span>
                    <span class="c1"># randomDepthIndBin is a dictionary that contains the entries for each</span>
                    <span class="c1"># basin and bathymetry bin, specifically the corresponding indices</span>
                    <span class="c1"># within the bathymetry array.</span>
                    <span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">depthBinLogical</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])])</span>                

            <span class="c1">## Factors which dictate the percentage of ocean volume movement</span>
            <span class="c1">## from bins with excess ocean volume</span>
            <span class="n">bin_redis_faction</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sxbin_p</span><span class="p">);</span>
            <span class="n">bin_redis_faction</span><span class="p">[</span><span class="n">bin_redis_faction</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">bin_redis_faction</span> <span class="o">=</span> <span class="n">bin_redis_faction</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_redis_faction</span><span class="p">);</span>
            
            <span class="c1">## Iterate over basins</span>
            <span class="k">for</span> <span class="n">basini</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">):</span>

                <span class="c1">## Find values to be changed in basini</span>
                <span class="n">logicalBasini</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">basini</span><span class="p">);</span>
            
                <span class="c1">## Define the volume reduction required in basini.</span>
                <span class="n">volReduction</span> <span class="o">=</span> <span class="n">totalVolRes</span><span class="o">*</span><span class="n">volBasin</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span>
            
                <span class="c1">## Iterate over bin depths</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basin &quot;</span><span class="p">,</span> <span class="n">basini</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>

                    <span class="c1">## Find the amount of ocean volume to be transfer between bin j (bins with</span>
                    <span class="c1">## excess ocean volume/area) and other bins (bins lacking ocean area representation).</span>
                    <span class="k">if</span> <span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1">## If bin has excess ocean area/volume</span>

                        <span class="c1">## Ocean volume to be removed through adding shallower depths than the current bin.</span>
                        <span class="n">sxbin_p_rm</span> <span class="o">=</span> <span class="n">sxbin_p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">];</span>
                        <span class="n">bini_redis_faction1</span> <span class="o">=</span> <span class="p">(</span> <span class="n">sxbin_p_rm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_rm</span><span class="p">[</span><span class="n">sxbin_p_rm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span><span class="o">/</span>\
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_rm</span><span class="p">[</span><span class="n">sxbin_p_rm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
                        <span class="c1">## Ocean volume to be added through adding deeper depths than the current bin.</span>
                        <span class="n">sxbin_p_add</span> <span class="o">=</span> <span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
                        <span class="n">bini_redis_faction2</span> <span class="o">=</span> <span class="p">(</span> <span class="n">sxbin_p_add</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_add</span><span class="p">[</span><span class="n">sxbin_p_add</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span><span class="o">/</span>\
                            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_add</span><span class="p">[</span><span class="n">sxbin_p_add</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
                        <span class="c1">## Ocean volume to be removed/added through adding shallower/deeper bins than the current bin</span>
                        <span class="n">bini_redis_faction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bini_redis_faction1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span><span class="n">bini_redis_faction2</span><span class="p">);</span>

                        <span class="c1">## Set maximum percentage of indices that can be changed in a bin that will have bathymetry</span>
                        <span class="c1">## removed from it.</span>
                        <span class="n">maxBin_p_Change</span> <span class="o">=</span> <span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="s2">&quot;Bin depth&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">j</span><span class="p">],</span><span class="s2">&quot;; bini_redis_faction &quot;</span><span class="p">,</span> <span class="n">bini_redis_faction</span><span class="p">)</span>

                        <span class="c1">## Apply volume correction to each basini bin i.                       </span>
                        <span class="n">binVolume</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>           <span class="c1"># (re)set binVolume each time we change start bin (every j interation)</span>
                        <span class="n">jjj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>                     <span class="c1"># (re)set jjj each time we change start bin (every j interation)</span>
                        <span class="n">areaChangeOut</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
                        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bini_redis_faction</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">bini_redis_faction</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Calculate how much ocean volume residual is</span>
                                <span class="c1"># represented in the lacking bin (bini_vol_residual)</span>
                                <span class="n">bini_vol_residual</span> <span class="o">=</span> <span class="n">totalVolRes</span><span class="o">*</span><span class="n">volBasinFrac</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="n">bin_redis_faction</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">bini_redis_faction</span><span class="p">[</span><span class="n">jj</span><span class="p">];</span>
                                <span class="n">volumeChange</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
                                <span class="n">areaChangeIn</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

                                <span class="c1"># Note1: this chooses the option for how the bathymetry</span>
                                <span class="c1"># should be redistrbuted to other bins.</span>
                                <span class="c1"># Note2: Also, this code will not excute unless the</span>
                                <span class="c1"># residual in bin (jj) constitutes &lt;1% of the total</span>
                                <span class="c1"># basin&#39;s residual between constant ocean volume and</span>
                                <span class="c1"># model.</span>
                                <span class="n">opt_max_vol_trans</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                                <span class="k">if</span> <span class="n">opt_max_vol_trans</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bini_vol_residual</span><span class="o">&gt;</span><span class="n">totalVolRes</span><span class="o">*</span><span class="n">volBasinFrac</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">):</span>
                                    <span class="n">max_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basini</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])])[</span><span class="mi">0</span><span class="p">];</span>

                                    <span class="k">while</span> <span class="n">volumeChange</span> <span class="o">&lt;</span> <span class="n">bini_vol_residual</span><span class="p">:</span>
                                        <span class="c1"># Reached ~100% of ocean volume at studied time or max indices at depth were move to other depths </span>
                                        <span class="n">opt_redis_cutoff</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
                                        <span class="k">if</span> <span class="n">opt_redis_cutoff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">VOCTarget</span><span class="p">):</span>
                                            <span class="c1"># print(&quot;Target global ocean volume is now predicted to be accurate for time. Some basins might be lacking basin volume representation compared to others.&quot;)</span>
                                            <span class="c1"># print(&quot;exit 1&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        <span class="k">elif</span> <span class="n">jjj</span> <span class="o">==</span> <span class="p">(</span><span class="n">max_ind</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                            <span class="c1"># print(&quot;Max indices were reached. No more redistributions can be done to reconcile ocean volume.&quot;)</span>
                                            <span class="c1"># print(&quot;exit 2&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        <span class="k">elif</span> <span class="n">areaBasin</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">maxBin_p_Change</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">areaChangeOut</span><span class="p">:</span>
                                            <span class="c1"># print(&quot;Max bathymetry area was reached. Such that further removal of bathymetry from bin {0}-{1} would lead to an underestimation of bin {0}-{1} area&quot;.format(self.binEdges[j], self.binEdges[j+1]))</span>
                                            <span class="c1"># print(&quot;exit 4&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        <span class="k">elif</span> <span class="n">areaBasin</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sxbin_p</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">areaChangeIn</span><span class="p">:</span>
                                            <span class="c1"># print(&quot;Max bathymetry area was reached in adding bin. Such that further adding of bathymetry to bin {0}-{1} would lead to an underestimation of bin {0}-{1} area&quot;.format(self.binEdges[jj], self.binEdges[jj+1]))</span>
                                            <span class="c1"># print(&quot;exit 5&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        
                                        <span class="c1"># Select random ind from random ind vector - This value will then be changed</span>
                                        <span class="c1">#   Note that ind is only random since randomDepthIndBin dictionary indices are</span>
                                        <span class="c1">#   randomly ordered.</span>
                                        <span class="n">ind</span> <span class="o">=</span> <span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basini</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])][</span><span class="n">jjj</span><span class="p">];</span>

                                        <span class="c1"># New depth - Choose depth randomly within bin or at maximum depth</span>
                                        <span class="n">bins_in_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">1e3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">,</span> <span class="mf">1e3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                                        <span class="n">new_depth</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bins_in_cal</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bins_in_cal</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]));</span>
                                        
                                        <span class="c1"># Find the min and max volume changes to new bin</span>
                                        <span class="n">delta_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">-</span><span class="n">new_depth</span><span class="p">));</span>

                                        <span class="c1"># Set new depth such that ocean volume is minimized</span>
                                        <span class="k">if</span> <span class="n">new_depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]):</span>
                                            <span class="c1"># New depth is shallower than old depth</span>
                                            <span class="n">new_depth</span> <span class="o">=</span> <span class="n">new_depth</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">)</span><span class="o">==</span><span class="n">delta_vol</span><span class="p">];</span>
                                        <span class="k">if</span> <span class="n">new_depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]):</span>
                                            <span class="c1"># New depth is deeper than old depth</span>
                                            <span class="n">new_depth</span> <span class="o">=</span> <span class="n">new_depth</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">)</span><span class="o">==</span><span class="n">delta_vol</span><span class="p">];</span>

                                        <span class="c1"># Report</span>
                                        <span class="k">if</span> <span class="n">volumeChange</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Old depth </span><span class="si">{}</span><span class="s2">, New depth </span><span class="si">{}</span><span class="s2">, volumeChange </span><span class="si">{}</span><span class="s2">, np.max(delta_vol) </span><span class="si">{}</span><span class="s2">, bini_vol_residual </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                                                                                                                                <span class="n">new_depth</span><span class="p">,</span>
                                                                                                                                                <span class="n">volumeChange</span><span class="p">,</span>
                                                                                                                                                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">),</span>
                                                                                                                                                <span class="n">bini_vol_residual</span><span class="p">))</span>

                                        <span class="c1"># Use the maximum volume change to new bin as new depth</span>
                                        <span class="k">if</span> <span class="n">volumeChange</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bini_vol_residual</span><span class="p">:</span>
                                            <span class="c1"># Append the volume change to lacking bin</span>
                                            <span class="n">volumeChange</span> <span class="o">=</span> <span class="n">volumeChange</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">);</span>
                                            <span class="c1"># Append the area changed</span>
                                            <span class="n">areaChangeOut</span>   <span class="o">=</span> <span class="n">areaChangeOut</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
                                            <span class="n">areaChangeIn</span>    <span class="o">=</span> <span class="n">areaChangeIn</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
                                            <span class="c1"># Append the depth to that of the lacking bin</span>
                                            <span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_depth</span><span class="p">);</span>
                                            <span class="c1"># Move to next random index of the over represented ocean volume bin</span>
                                            <span class="n">jjj</span><span class="o">=</span><span class="n">jjj</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="c1"># Scenario where depth cannot be added with</span>
                                            <span class="c1"># out exceeding the residual volume</span>
                                            <span class="c1"># correction for that bin</span>
                                            <span class="c1"># print(&quot;exit 3&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>

                                <span class="c1"># Tracks the amount of ocean volume removed</span>
                                <span class="n">basinVolumeRemoved</span> <span class="o">+=</span> <span class="n">volumeChange</span><span class="p">;</span>
                                <span class="n">binVolume</span> <span class="o">+=</span> <span class="n">bini_vol_residual</span><span class="p">;</span>


            <span class="c1"># Report</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c1"># Create bathymetry histogram (for model at 0 Ma) that includes VOC corrections</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistVOCcorrection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlatVOCcorrection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span> <span class="o">=</span> <span class="n">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

                <span class="n">blues_cm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resampled</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">plotFnc2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">bathymetry</span><span class="p">,</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)]),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="p">)]),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistVOCcorrection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span>
                         <span class="n">outputDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                         <span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;plotGlobal-VOCCorrection.png&quot;</span><span class="p">,</span>
                         <span class="n">cmapOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cmap&quot;</span><span class="p">:</span><span class="n">blues_cm</span><span class="p">,</span>
                                   <span class="s2">&quot;cbar-title&quot;</span><span class="p">:</span><span class="s2">&quot;cbar-title&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;cbar-range&quot;</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)]},</span>
                         <span class="n">pltOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;valueType&quot;</span><span class="p">:</span> <span class="s2">&quot;Bathymetry&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;valueUnits&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;plotTitle&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;plotZeroContour&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">},</span>
                         <span class="n">saveSVG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">savePNG</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If age is not present-day then use previously calculated sxbin_p</span>
            <span class="c1"># to apply basin volume correction.</span>

            <span class="c1"># Calculate basin parameters. This produces the following useful values</span>
            <span class="c1">## self.basins.BasinIDA : Global array with values corresponding to basin ID</span>
            <span class="c1">## self.basins.bathymetryAreaDistBasin : [&quot;Basin0&quot;, &quot;Basin1&quot;,...].  Note that</span>
            <span class="c1">##      this distribution is calculated with the exclusion of high latitude</span>
            <span class="c1">##      distribution of seafloor depths. This is what is normally inputted into</span>
            <span class="c1">##      the LOSCAR carbon cycle model.</span>
            <span class="c1">## self.basins.bathymetryVolFraction : [&quot;Basin0&quot;, &quot;Basin1&quot;,...]. Each entry contains</span>
            <span class="c1">##      the precent basin volume, normalized to the volume of all ocean basins</span>
            <span class="c1">##      (excluding the high latitude ocean volume).</span>
            <span class="c1">## self.basins.bathymetryAreaFraction : [&quot;Basin0&quot;, &quot;Basin1&quot;,...]. Each entry contains</span>
            <span class="c1">##      the precent basin area, normalized to the total seafloor area (including</span>
            <span class="c1">##      the high latitude area).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">calculateBasinParameters</span><span class="p">()</span>

            <span class="c1"># Apply bathymetry/VOC correction for present-day bathymetry model basin-by-basin</span>
            
            
            <span class="c1">## Define basin count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="p">)]</span> <span class="p">))</span>

            <span class="c1">## Define basin area and volume fractions</span>
            <span class="n">volBasin</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">);</span>
            <span class="n">areaBasin</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">);</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">):</span>
                <span class="n">areaBasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
                <span class="n">volBasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">bathymetry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
            
            <span class="c1">## Use volume fraction of ocean to determine the fraction of ocean volume correction that should be applied to each basin</span>
            <span class="n">totalVolRes</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">volBasin</span><span class="p">)</span><span class="o">-</span><span class="n">VOCTarget</span><span class="p">)</span>

            <span class="c1">## Total basin volume fractions</span>
            <span class="n">volBasinFrac</span> <span class="o">=</span> <span class="n">volBasin</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">volBasin</span><span class="p">);</span>

            <span class="c1">## Calculate percents to add to each bin then plot</span>
            <span class="n">sxbin_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sxbin_p</span><span class="p">;</span>
            
            <span class="c1">## Tracks the amount of ocean volume removed</span>
            <span class="n">basinVolumeRemoved</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            
            <span class="c1">## Create logical to represent all values of depth_in in each bin (depthBinLogical)</span>
            <span class="n">randomDepthIndBin</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">):</span>
                 
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>

                    <span class="c1"># Note that depthBinLogical represents an (nx2) array with rows</span>
                    <span class="c1"># representing indecies of points that lie within basini and </span>
                    <span class="c1"># self.binEdges[j] and self.binEdges[j+1] depths.</span>
                    <span class="c1"># Note that self.binEdges values are in units of km.</span>
                    <span class="c1"># Note that bathymetry is positive and in units of m.</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">):</span>      <span class="c1"># Contains depths between current bin and next bin</span>
                        <span class="n">depthBinLogical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">&amp;</span><span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">)</span> <span class="p">);</span>
                    <span class="k">else</span><span class="p">:</span>                        <span class="c1"># The last bin which contains depths below bins_in(end)</span>
                        <span class="n">depthBinLogical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">i</span><span class="p">)</span> <span class="p">);</span>
                    
                    <span class="n">verbose2</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">verbose2</span><span class="p">:</span>
                        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">for</span> <span class="n">pointi</span> <span class="ow">in</span> <span class="n">depthBinLogical</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basin-</span><span class="si">{0}</span><span class="s2">_Bin-</span><span class="si">{1}</span><span class="s2">_to_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">bathymetry</span><span class="p">[</span><span class="n">pointi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pointi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="n">cnt</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Random_depth_ind represents random depths to modify</span>
                    <span class="c1"># This has a very minor effect on bathymetry distributions input</span>
                    <span class="c1"># into LOSCAR.</span>
                    <span class="c1"># randomDepthIndBin is a dictionary that contains the entries for each</span>
                    <span class="c1"># basin and bathymetry bin, specifically the corresponding indices</span>
                    <span class="c1"># within the bathymetry array.</span>
                    <span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">depthBinLogical</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])])</span>                

            <span class="c1">## Factors which dictate the percentage of ocean volume movement</span>
            <span class="c1">## from bins with excess ocean volume</span>
            <span class="n">bin_redis_faction</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sxbin_p</span><span class="p">);</span>
            <span class="n">bin_redis_faction</span><span class="p">[</span><span class="n">bin_redis_faction</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">bin_redis_faction</span> <span class="o">=</span> <span class="n">bin_redis_faction</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_redis_faction</span><span class="p">);</span>
            
            <span class="c1">## Iterate over basins</span>
            <span class="k">for</span> <span class="n">basini</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinCnt</span><span class="p">):</span>

                <span class="c1">## Find values to be changed in basini</span>
                <span class="n">logicalBasini</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="o">.</span><span class="n">BasinIDA</span><span class="o">==</span><span class="n">basini</span><span class="p">);</span>
            
                <span class="c1">## Define the volume reduction required in basini.</span>
                <span class="n">volReduction</span> <span class="o">=</span> <span class="n">totalVolRes</span><span class="o">*</span><span class="n">volBasin</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span>
            
                <span class="c1">## Iterate over bin depths</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basin &quot;</span><span class="p">,</span> <span class="n">basini</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
                        <span class="c1">## If bin has excess ocean area/volume</span>

                        <span class="c1">## Ocean volume to be removed through adding shallower depths than the current bin.</span>
                        <span class="n">sxbin_p_rm</span> <span class="o">=</span> <span class="n">sxbin_p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">];</span>
                        <span class="n">bini_redis_faction1</span> <span class="o">=</span> <span class="p">(</span> <span class="n">sxbin_p_rm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_rm</span><span class="p">[</span><span class="n">sxbin_p_rm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span><span class="o">/</span>\
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_rm</span><span class="p">[</span><span class="n">sxbin_p_rm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
                        <span class="c1">## Ocean volume to be added through adding deeper depths than the current bin.</span>
                        <span class="n">sxbin_p_add</span> <span class="o">=</span> <span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
                        <span class="n">bini_redis_faction2</span> <span class="o">=</span> <span class="p">(</span> <span class="n">sxbin_p_add</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_add</span><span class="p">[</span><span class="n">sxbin_p_add</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span><span class="o">/</span>\
                            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sxbin_p_add</span><span class="p">[</span><span class="n">sxbin_p_add</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
                        <span class="c1">## Ocean volume to be removed/added through adding shallower/deeper bins than the current bin</span>
                        <span class="n">bini_redis_faction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bini_redis_faction1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span><span class="n">bini_redis_faction2</span><span class="p">);</span>

                        <span class="c1">## Set maximum percentage of indices that can be changed in a bin that will have bathymetry</span>
                        <span class="c1">## removed from it.</span>
                        <span class="n">maxBin_p_Change</span> <span class="o">=</span> <span class="n">sxbin_p</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="s2">&quot;Bin depth&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">j</span><span class="p">],</span><span class="s2">&quot;; bini_redis_faction &quot;</span><span class="p">,</span> <span class="n">bini_redis_faction</span><span class="p">)</span>

                        <span class="c1">## Apply volume correction to each basini bin i.                       </span>
                        <span class="n">binVolume</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>           <span class="c1"># (re)set binVolume each time we change start bin (every j interation)</span>
                        <span class="n">jjj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>                     <span class="c1"># (re)set jjj each time we change start bin (every j interation)</span>
                        <span class="n">areaChangeOut</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
                        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bini_redis_faction</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">bini_redis_faction</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Calculate how much ocean volume residual is</span>
                                <span class="c1"># represented in the lacking bin (bini_vol_residual)</span>
                                <span class="n">bini_vol_residual</span> <span class="o">=</span> <span class="n">totalVolRes</span><span class="o">*</span><span class="n">volBasinFrac</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="n">bin_redis_faction</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">bini_redis_faction</span><span class="p">[</span><span class="n">jj</span><span class="p">];</span>
                                <span class="n">volumeChange</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
                                <span class="n">areaChangeIn</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
                                
                                <span class="c1"># Note1: this chooses the option for how the bathymetry</span>
                                <span class="c1"># should be redistrbuted to other bins.</span>
                                <span class="c1"># Note2: Also, this code will not excute unless the</span>
                                <span class="c1"># residual in bin (jj) constitutes &lt;1% of the total</span>
                                <span class="c1"># residual between constant ocean volume and model.</span>
                                <span class="n">opt_max_vol_trans</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                                <span class="k">if</span> <span class="n">opt_max_vol_trans</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bini_vol_residual</span><span class="o">&gt;</span><span class="n">totalVolRes</span><span class="o">*</span><span class="n">volBasinFrac</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">):</span>
                                    <span class="n">max_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basini</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])])[</span><span class="mi">0</span><span class="p">];</span>

                                    <span class="k">while</span> <span class="n">volumeChange</span> <span class="o">&lt;</span> <span class="n">bini_vol_residual</span><span class="p">:</span>
                                        <span class="c1"># Reached ~100% of ocean volume at studied time or max indices at depth were move to other depths </span>
                                        <span class="n">opt_redis_cutoff</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
                                        <span class="n">opt_redis_cutoff</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
                                        <span class="k">if</span> <span class="n">opt_redis_cutoff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">VOCTarget</span><span class="p">):</span>
                                            <span class="c1"># print(&quot;Target global ocean volume is now predicted to be accurate for time. Some basins might be lacking basin volume representation compared to others.&quot;)</span>
                                            <span class="c1"># print(&quot;exit 1&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        <span class="k">elif</span> <span class="n">jjj</span> <span class="o">==</span> <span class="p">(</span><span class="n">max_ind</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                            <span class="c1"># print(&quot;Max indices were reached. No more redistributions can be done to reconcile ocean volume.&quot;)</span>
                                            <span class="c1"># print(&quot;exit 2&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        <span class="k">elif</span> <span class="n">areaBasin</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">maxBin_p_Change</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">areaChangeOut</span><span class="p">:</span>
                                            <span class="c1"># print(&quot;Max bathymetry area was reached. Such that further removal of bathymetry from bin {0}-{1} would lead to an underestimation of bin {0}-{1} area&quot;.format(self.binEdges[j], self.binEdges[j+1]))</span>
                                            <span class="c1"># print(&quot;exit 4&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        <span class="k">elif</span> <span class="n">areaBasin</span><span class="p">[</span><span class="n">basini</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sxbin_p</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">areaChangeIn</span><span class="p">:</span>
                                            <span class="c1"># print(&quot;Max bathymetry area was reached in adding bin. Such that further adding of bathymetry to bin {0}-{1} would lead to an underestimation of bin {0}-{1} area&quot;.format(self.binEdges[jj], self.binEdges[jj+1]))</span>
                                            <span class="c1"># print(&quot;exit 5&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>
                                        
                                        <span class="c1"># Select random ind from random ind vector - This value will then be changed</span>
                                        <span class="c1">#   Note that ind is only random since randomDepthIndBin dictionary indices are</span>
                                        <span class="c1">#   randomly ordered.</span>
                                        <span class="n">ind</span> <span class="o">=</span> <span class="n">randomDepthIndBin</span><span class="p">[</span><span class="s2">&quot;Basin-</span><span class="si">{0:0.0f}</span><span class="s2">_Bin-</span><span class="si">{1:0.0f}</span><span class="s2">_to_</span><span class="si">{2:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basini</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])][</span><span class="n">jjj</span><span class="p">];</span>

                                        <span class="c1"># New depth - Choose depth randomly within bin or at maximum depth</span>
                                        <span class="n">bins_in_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">1e3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">,</span> <span class="mf">1e3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                                        <span class="n">new_depth</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bins_in_cal</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bins_in_cal</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]));</span>
                                        
                                        <span class="c1"># Find the min and max volume changes to new bin</span>
                                        <span class="n">delta_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">-</span><span class="n">new_depth</span><span class="p">));</span>

                                        <span class="c1"># Set new depth such that ocean volume is minimized</span>
                                        <span class="k">if</span> <span class="n">new_depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]):</span>
                                            <span class="c1"># New depth is shallower than old depth</span>
                                            <span class="n">new_depth</span> <span class="o">=</span> <span class="n">new_depth</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">)</span><span class="o">==</span><span class="n">delta_vol</span><span class="p">];</span>
                                        <span class="k">if</span> <span class="n">new_depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]):</span>
                                            <span class="c1"># New depth is deeper than old depth</span>
                                            <span class="n">new_depth</span> <span class="o">=</span> <span class="n">new_depth</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">)</span><span class="o">==</span><span class="n">delta_vol</span><span class="p">];</span>

                                        <span class="c1"># Report</span>
                                        <span class="k">if</span> <span class="n">volumeChange</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Old depth </span><span class="si">{}</span><span class="s2">, New depth </span><span class="si">{}</span><span class="s2">, volumeChange </span><span class="si">{}</span><span class="s2">, np.max(delta_vol) </span><span class="si">{}</span><span class="s2">, bini_vol_residual </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                                                                                                                                <span class="n">new_depth</span><span class="p">,</span>
                                                                                                                                                <span class="n">volumeChange</span><span class="p">,</span>
                                                                                                                                                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">),</span>
                                                                                                                                                <span class="n">bini_vol_residual</span><span class="p">))</span>

                                        <span class="c1"># Use the maximum volume change to new bin as new depth</span>
                                        <span class="k">if</span> <span class="n">volumeChange</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bini_vol_residual</span><span class="p">:</span>
                                            <span class="c1"># Append the volume change to lacking bin</span>
                                            <span class="n">volumeChange</span> <span class="o">=</span> <span class="n">volumeChange</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_vol</span><span class="p">);</span>
                                            <span class="c1"># Append the area changed</span>
                                            <span class="n">areaChangeOut</span>   <span class="o">=</span> <span class="n">areaChangeOut</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
                                            <span class="n">areaChangeIn</span>    <span class="o">=</span> <span class="n">areaChangeIn</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
                                            <span class="c1"># Append the depth to that of the lacking bin</span>
                                            <span class="n">bathymetry</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_depth</span><span class="p">);</span>
                                            <span class="c1"># Move to next random index of the over represented ocean volume bin</span>
                                            <span class="n">jjj</span><span class="o">=</span><span class="n">jjj</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="c1"># Scenario where depth cannot be added with</span>
                                            <span class="c1"># out exceeding the residual volume</span>
                                            <span class="c1"># correction for that bin</span>
                                            <span class="c1"># print(&quot;exit 3&quot;)</span>
                                            <span class="c1"># print(&quot;np.nansum(bathymetry*self.areaWeights)&quot;, np.nansum(bathymetry*self.areaWeights))</span>
                                            <span class="c1"># print(&quot;VOCTarget&quot;, VOCTarget)</span>
                                            <span class="k">break</span>

                                <span class="c1"># Tracks the amount of ocean volume removed</span>
                                <span class="n">basinVolumeRemoved</span> <span class="o">+=</span> <span class="n">volumeChange</span><span class="p">;</span>
                                <span class="n">binVolume</span> <span class="o">+=</span> <span class="n">bini_vol_residual</span><span class="p">;</span>
            <span class="c1"># Report</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c1"># Create bathymetry histogram (for model at 0 Ma) that includes VOC corrections</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistVOCcorrection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlatVOCcorrection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span> <span class="o">=</span> <span class="n">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
                <span class="c1"># Create bathymetry histogram (for etopo)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span> <span class="o">=</span> <span class="n">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>


                <span class="n">blues_cm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resampled</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">plotFnc2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">bathymetry</span><span class="p">,</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)]),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="p">)]),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etopobathymetry</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">areaWeights</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">binEdges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistVOCcorrection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bathymetryAreaDistEtopo</span><span class="p">,</span>
                         <span class="n">outputDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                         <span class="n">fidName</span> <span class="o">=</span> <span class="s2">&quot;plotGlobal-VOCCorrection.png&quot;</span><span class="p">,</span>
                         <span class="n">cmapOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cmap&quot;</span><span class="p">:</span><span class="n">blues_cm</span><span class="p">,</span>
                                   <span class="s2">&quot;cbar-title&quot;</span><span class="p">:</span><span class="s2">&quot;cbar-title&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;cbar-range&quot;</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)]},</span>
                         <span class="n">pltOpts</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;valueType&quot;</span><span class="p">:</span> <span class="s2">&quot;Bathymetry&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;valueUnits&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;plotTitle&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;plotZeroContour&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">},</span>
                         <span class="n">saveSVG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">savePNG</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">bathymetry</span><span class="p">,</span> <span class="n">sxbin_p</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;working progress&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BathyRecon.saveNetCDF4">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.saveNetCDF4">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">saveNetCDF4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Placeholder for writing additional consolidated outputs.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Not yet implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="BathyRecon.compareLithosphereAndPaleoDEMRecon">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathyRecon.compareLithosphereAndPaleoDEMRecon">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compareLithosphereAndPaleoDEMRecon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">fuzzyAge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quick visual check of coverage and consistency between lithosphere-age</span>
<span class="sd">        grids and paleoDEMs at a given time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        age : int</span>
<span class="sd">            Reconstruction age (Ma).</span>
<span class="sd">        resolution : float</span>
<span class="sd">            Grid spacing (deg).</span>
<span class="sd">        fuzzyAge : bool, optional</span>
<span class="sd">            If True, allows nearest match in available products.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Side Effects</span>
<span class="sd">        ------------</span>
<span class="sd">        Produces a contour plot of lithosphere ages with paleoDEM coastlines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="c1"># Read the ocean lithosphere ages and paleoDEM for the reconstruction</span>
        <span class="c1"># period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getDEM</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">fuzzyAge</span><span class="o">=</span><span class="n">fuzzyAge</span><span class="p">);</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getOceanLithosphereAgeGrid</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">fuzzyAge</span><span class="o">=</span><span class="n">fuzzyAge</span><span class="p">);</span>

        <span class="c1"># Plot lithosphere ages overlain by coastlines from the paleoDEMS.</span>
        <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:])</span>
        <span class="c1">#plt.contourf(XX, YY, self.paleoDEM[&#39;z&#39;][:].data)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oceanLithAge</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paleoDEM</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">);</span></div>
</div>



<div class="viewcode-block" id="BathySynthBogumil24">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathySynthBogumil24">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BathySynthBogumil24</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build synthetic, basin-agnostic bathymetry distributions following</span>
<span class="sd">    the design in Bogumil et al. (2024).</span>

<span class="sd">    Unlike spatial reconstructions, this class does **not** operate on</span>
<span class="sd">    latitude/longitude grids. Instead, it synthesizes global depth-bin</span>
<span class="sd">    distributions and formats them using ``BasinsSynth`` so they can be</span>
<span class="sd">    consumed by LOSCAR-style carbon cycle models.</span>

<span class="sd">    Concept</span>
<span class="sd">    -------</span>
<span class="sd">    1. Basins share identical depth distributions (contrast with geologic</span>
<span class="sd">       reconstructions where basins differ).</span>
<span class="sd">    2. Deep bathymetry (&gt; 1 km) follows a Gaussian-like 5-bin pattern</span>
<span class="sd">       centered on a chosen bin (σ ≈ 250–500 m depending on bin width).</span>
<span class="sd">    3. Shallow bins (≤ 600 m) are allocated uniformly and varied in area</span>
<span class="sd">       within plausible ranges over 0–80 Ma.</span>

<span class="sd">    Distinctions vs. Bogumil et al. (2024)</span>
<span class="sd">    --------------------------------------</span>
<span class="sd">    1. In Bogumil et al., LOSCAR mixing parameters were fixed at PD values;</span>
<span class="sd">       here, *connectivity bathymetry* (not mixing coefficients) is</span>
<span class="sd">       defined from the synthetic Gaussian distribution. Other classes may</span>
<span class="sd">       choose whether to drive mixing by these synthetic distributions or</span>
<span class="sd">       keep LOSCAR defaults.</span>
<span class="sd">    2. VOC is computed directly as ``(total area) × (depth distribution)``.</span>
<span class="sd">    3. Basin VOC partitions are derived from basin area fractions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    optSynthModel : {&#39;Model1&#39;}, optional</span>
<span class="sd">        Synthetic recipe to use. Currently only &#39;Model1&#39; is implemented:</span>
<span class="sd">        Gaussian deep bathymetry + variable shallow fraction. Default &#39;Model1&#39;.</span>
<span class="sd">    ModelName : str, optional</span>
<span class="sd">        Name used for on-disk outputs (subdirectory and file prefixes).</span>
<span class="sd">        Default &#39;myModel&#39;.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    LOSCARValues : dict</span>
<span class="sd">        Convenience constants matching LOSCAR conventions:</span>
<span class="sd">        - ``AOC`` : float</span>
<span class="sd">            Global seafloor area [m²], default 3.49e14.</span>
<span class="sd">        - ``hb10`` : float</span>
<span class="sd">            High-latitude *surface box depth* [m] (not seafloor depth), default 250.</span>
<span class="sd">        - ``fanoc`` : (4, 1) ndarray</span>
<span class="sd">            Area fractions for Atlantic, Indian, Pacific, High-lat boxes (decimal).</span>
<span class="sd">        - ``binEdges`` : (N,) ndarray</span>
<span class="sd">            Upper bounds of bathymetry bins [m]: 0, 100, 600, 1000, …, 6500.</span>
<span class="sd">    optSynthModel : str</span>
<span class="sd">        The selected synthetic model key (e.g., &#39;Model1&#39;).</span>
<span class="sd">    ModelName : str</span>
<span class="sd">        Logical name for the model family; used in output paths.</span>
<span class="sd">    AOC_factor : ndarray of shape (3,)</span>
<span class="sd">        For &#39;Model1&#39;: ``[min_factor, max_factor, n_steps]`` controlling</span>
<span class="sd">        how total AOC is scaled relative to LOSCAR present-day.</span>
<span class="sd">        Default ``[0.96, 1.2, 13]`` → 13 evenly spaced factors in [0.96, 1.20].</span>
<span class="sd">    synth_model_para : dict</span>
<span class="sd">        Free parameters controlling the synthetic shape. Currently:</span>
<span class="sd">        - ``&#39;shallow_bathy_percent&#39;`` : float</span>
<span class="sd">            Fraction of global seafloor area assigned to the two shallowest</span>
<span class="sd">            non-zero bins (split evenly). Default 0.025 (2.5%).</span>
<span class="sd">    directories : dict</span>
<span class="sd">        Output directory roots. ``directories[&#39;output&#39;]`` points to</span>
<span class="sd">        ``./bathymetries/{optSynthModel}/{ModelName}``.</span>
<span class="sd">    BathymetryParms : dict</span>
<span class="sd">        Populated by :meth:`makeSynthModels`. A mapping:</span>
<span class="sd">        ``model_key -&gt; {&#39;VOC&#39;, &#39;AOC&#39;, &#39;fanoc&#39;, &#39;fdvol&#39;, &#39;hb10&#39;, &#39;distribution&#39;}``,</span>
<span class="sd">        where:</span>
<span class="sd">        - ``VOC`` : float, total ocean volume [m³].</span>
<span class="sd">        - ``AOC`` : float, total ocean area [m²].</span>
<span class="sd">        - ``fanoc`` : (4,) ndarray, basin/HL area fractions (decimal).</span>
<span class="sd">        - ``fdvol`` : (4,) ndarray, basin/HL volume fractional partition (decimal),</span>
<span class="sd">          normalized to the sum over the **three** ocean basins (HL excluded in norm).</span>
<span class="sd">        - ``hb10`` : float, high-lat surface box depth [m].</span>
<span class="sd">        - ``distribution`` : (len(binEdges)-1,) ndarray,</span>
<span class="sd">          global % area per depth bin (decimal, excludes the 0 m edge).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The Gaussian “deep” vector in *Model1* is applied across five</span>
<span class="sd">      adjacent 500 m-spaced bins centered on a chosen bin index and</span>
<span class="sd">      renormalized to honor the shallow share and AOC scaling.</span>
<span class="sd">    - Land is not represented—distributions are purely oceanic (% over AOC).</span>
<span class="sd">    - Outputs are formatted with :class:`utils.BasinsSynth` for downstream use.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Bogumil, T. R., et al. (2024), *PNAS*, doi:10.1073/pnas.2400232121</span>
<span class="sd">    LOSCAR documentation (area partitions and bin definitions).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optSynthModel</span><span class="o">=</span><span class="s1">&#39;Model1&#39;</span><span class="p">,</span> <span class="n">ModelName</span><span class="o">=</span><span class="s1">&#39;myModel&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a synthetic bathymetry generator and set LOSCAR defaults.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        optSynthModel : {&#39;Model1&#39;}, optional</span>
<span class="sd">            Synthetic recipe key. Currently only &#39;Model1&#39; is implemented.</span>
<span class="sd">        ModelName : str, optional</span>
<span class="sd">            Human-readable model family name used in filenames/paths.</span>

<span class="sd">        Side Effects</span>
<span class="sd">        ------------</span>
<span class="sd">        - Creates ``LOSCARValues`` with canonical area, binning, and fractions.</span>
<span class="sd">        - Defines AOC scaling sweep in :attr:`AOC_factor`.</span>
<span class="sd">        - Sets the output directory root in :attr:`directories`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define Some Default LOSCAR variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;AOC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.49e14</span><span class="p">;</span> <span class="c1"># Seafloor area as defined in LOSCAR [m2]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;hb10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span> <span class="c1"># Depth of the high latitude surface box [m], note that this is note the depth of the high latitude seafloor.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;fanoc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="mf">.26</span><span class="p">],[</span><span class="mf">.18</span><span class="p">],[</span><span class="mf">.46</span><span class="p">],[</span><span class="mf">.10</span><span class="p">]));</span> <span class="c1"># A, I, P, and Highlat surface area fraction [%]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">.1</span><span class="p">],[</span><span class="mf">.6</span><span class="p">],[</span><span class="mf">1.</span><span class="p">],[</span><span class="mf">1.5</span><span class="p">],[</span><span class="mf">2.</span><span class="p">],[</span><span class="mf">2.5</span><span class="p">],[</span><span class="mf">3.</span><span class="p">],[</span><span class="mf">3.5</span><span class="p">],[</span><span class="mf">4.</span><span class="p">],[</span><span class="mf">4.5</span><span class="p">],[</span><span class="mf">5.</span><span class="p">],[</span><span class="mf">5.5</span><span class="p">],[</span><span class="mf">6.5</span><span class="p">]))</span><span class="o">*</span><span class="mf">1e3</span><span class="p">;</span> <span class="c1"># Bathymetry distribution bin edges as defined in LOSCAR [m]</span>
        
        <span class="c1"># Define synthetic model parameters (Deep bathymetry gaussian sigma, Shallow bathymetry extent)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optSynthModel</span> <span class="o">=</span> <span class="n">optSynthModel</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelName</span> <span class="o">=</span> <span class="n">ModelName</span><span class="p">;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optSynthModel</span> <span class="o">==</span> <span class="s1">&#39;Model1&#39;</span><span class="p">:</span>
            <span class="c1"># Factor to vary seafloor area by with respect to present-day (LOSCAR seafloor area)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AOC_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">.96</span><span class="p">,</span><span class="mf">1.2</span><span class="p">,</span><span class="mi">13</span><span class="p">]);</span>
        
        <span class="n">shallow_bathy_percent</span> <span class="o">=</span> <span class="mf">.025</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synth_model_para</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shallow_bathy_percent&#39;</span><span class="p">:</span><span class="n">shallow_bathy_percent</span><span class="p">};</span>

        <span class="c1"># Define some directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directories</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/bathymetries/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optSynthModel</span><span class="p">,</span> <span class="n">ModelName</span><span class="p">)</span>

<div class="viewcode-block" id="BathySynthBogumil24.makeSynthModels">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathySynthBogumil24.makeSynthModels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">makeSynthModels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a suite of synthetic depth distributions and cache parameters.</span>

<span class="sd">        For *Model1*, each realization combines:</span>
<span class="sd">        - a 5-bin Gaussian-like deep pattern centered successively on</span>
<span class="sd">          eligible bin centers between ~1–5 km, and</span>
<span class="sd">        - a uniform shallow allocation split between the two shallow bins,</span>
<span class="sd">          sized by ``synth_model_para[&#39;shallow_bathy_percent&#39;]``.</span>

<span class="sd">        For each AOC scale factor in ``np.linspace(AOC_factor[0],</span>
<span class="sd">        AOC_factor[1], int(AOC_factor[2]))`` and each valid deep-bin center:</span>

<span class="sd">        - Compute distribution (% per bin, decimal).</span>
<span class="sd">        - Compute basin/HL volume split ``fdvol`` using LOSCAR</span>
<span class="sd">          area fractions (``fanoc``) and the distribution.</span>
<span class="sd">        - Compute target VOC as the area-weighted integral of depths.</span>
<span class="sd">        - Store all quantities to :attr:`BathymetryParms` under a model key</span>
<span class="sd">          like ``aF{factor%}_U{bin_edge}m``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The “Gaussian” deep vector used is</span>
<span class="sd">          ``[(100 - 34.1*2 - 13.6*2)/2, 13.6, 34.1*2, 13.6, (100 - 34.1*2 - 13.6*2)/2] * 1e-2``,</span>
<span class="sd">          which approximates (~13.6%, 68.2%, 13.6%) tails/center mass over five bins.</span>
<span class="sd">        - The shallow share is removed from the deep mass and split evenly</span>
<span class="sd">          into bins at 100 m and 600 m (following LOSCAR bin edges).</span>
<span class="sd">        - All percentages are maintained in **decimal** form internally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optSynthModel</span> <span class="o">==</span> <span class="s1">&#39;Model1&#39;</span><span class="p">:</span>
            <span class="c1"># Gaussian distributed deep bathymetry with varying shallow seafloor area.</span>
            <span class="c1"># Description of the distribution used for the synthetic bathymetry models</span>
            <span class="c1"># (..., 13.6, 68.2, 13.6, ...) normal distribution w/ mu=bin-250 m, sigma = 250 m</span>
            <span class="c1"># Note that mu and sigma only hold for distributions applied to bins which are spaced in 500 m intervals. (i.e. mu = 2000 m,..., 4500 m)</span>
            <span class="n">deep_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">100</span><span class="o">-</span><span class="mf">34.1</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span><span class="mf">13.6</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mf">13.6</span><span class="p">,</span> <span class="mf">34.1</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mf">13.6</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="mf">34.1</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span><span class="mf">13.6</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
            
            <span class="c1"># Placeholder make distributions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            
            <span class="c1"># Dictionary to hold dictionaries of synthetic bathymetry parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="c1"># </span>
            <span class="n">interation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="n">areaFactori</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC_factor</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                <span class="n">areaFactori</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">areaFactori</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
                <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">7</span><span class="p">):</span>
                    <span class="c1"># Iterates over binEdges at which gaussian distributed bathymetry is maximum.</span>
                    <span class="c1">#   I.e., we create bathymetry models with seafloor at depths defined in the binEdges.</span>
                    
                    <span class="c1"># Create distribution vector</span>
                    <span class="n">distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">])));</span>
                    <span class="c1"># Set deep bathymetry fraction for distribution</span>
                    <span class="n">distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">bin_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">bin_idx</span><span class="o">+</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">deep_dist</span><span class="o">*</span><span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">synth_model_para</span><span class="p">[</span><span class="s1">&#39;shallow_bathy_percent&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">2.0</span> <span class="p">)</span><span class="o">/</span><span class="n">areaFactori</span><span class="p">;</span>
                    
                    <span class="c1"># Set shallow bathymetry fraction for distribution</span>
                    <span class="n">distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">bin_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">bin_idx</span><span class="o">+</span><span class="mi">7</span><span class="p">])</span> <span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="c1"># (1-2*(areaFactori-1));</span>
                    <span class="n">distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">bin_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">bin_idx</span><span class="o">+</span><span class="mi">7</span><span class="p">])</span> <span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="c1"># (1-2*(areaFactori-1));</span>

                    <span class="c1"># Calculate ocean volume per basin using AOC and distribution + highlat depth and area [m3]</span>
                    <span class="c1">## Define fdvol as the volume, m3, of each basin and the high latitude box.</span>
                    <span class="n">fdvol</span>   <span class="o">=</span> <span class="n">areaFactori</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;AOC&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">distribution</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;fanoc&#39;</span><span class="p">]);</span>
                    <span class="c1">## Redefine fdvol as a vector of ocean basin volume, in decimal percentage</span>
                    <span class="c1">## of total ocean basin volume. Note that the high latitude box component</span>
                    <span class="c1">## volume is removed in these percentages. </span>
                    <span class="n">fdvol</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fdvol</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fdvol</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">));</span> 

                    <span class="c1"># Calculate VOC using AOC and distribution + highlat depth and area [m3]</span>
                    <span class="c1">#VOC = self.LOSCARValues[&#39;hb10&#39;]*areaFactori*self.LOSCARValues[&#39;AOC&#39;]*(self.LOSCARValues[&#39;fanoc&#39;][3]) + np.sum( areaFactori*self.LOSCARValues[&#39;AOC&#39;] * (distribution * self.LOSCARValues[&#39;binEdges&#39;].transpose()) * (self.LOSCARValues[&#39;fanoc&#39;][0:3]*1e-2) ); # [meters^3]</span>
                    <span class="n">VOC</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">areaFactori</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;AOC&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">distribution</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;fanoc&#39;</span><span class="p">])</span> <span class="p">);</span> <span class="c1"># m3.</span>

                    <span class="c1"># Constant high latitude area</span>
                    <span class="c1">#fanoc = (1/(self.LOSCARValues[&#39;fanoc&#39;][-1]*areaFactori))</span>
                    <span class="c1">#fanoc = np.append( fanoc, self.LOSCARValues[&#39;fanoc&#39;][0:3]*((1-fanoc)/.9) )</span>
                    
                    
                    <span class="c1"># Stack varibles VOC, AOC, fanoc, hb10, distribution                    </span>
                    <span class="n">outputi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">VOC</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;AOC&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">areaFactori</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">outputi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">outputi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;fanoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,)))</span> <span class="p">)</span>
                    <span class="n">outputi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">outputi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;hb10&#39;</span><span class="p">])</span> <span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">outputi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">outputi</span><span class="p">,</span> <span class="n">distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>

                    <span class="n">modeliString</span> <span class="o">=</span> <span class="s1">&#39;aF</span><span class="si">{}</span><span class="s1">_U</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">1e2</span><span class="o">*</span><span class="n">areaFactori</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">][</span><span class="n">bin_idx</span><span class="p">])));</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;VOC&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">VOC</span><span class="p">;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;AOC&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;AOC&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">areaFactori</span><span class="p">;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;fanoc&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;fanoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,));</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;fdvol&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">fdvol</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;hb10&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;hb10&#39;</span><span class="p">];</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:];</span></div>

                    
<div class="viewcode-block" id="BathySynthBogumil24.saveSynthModels">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.BathySynthBogumil24.saveSynthModels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">saveSynthModels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write synthetic distributions to standardized netCDF via BasinsSynth.</span>

<span class="sd">        This method iterates the same (AOC factor × deep-center) grid used</span>
<span class="sd">        in :meth:`makeSynthModels`, pulls the cached parameters from</span>
<span class="sd">        :attr:`BathymetryParms`, and writes one ``bathymetry_*_wBasins.nc``</span>
<span class="sd">        per realization using :class:`utils.BasinsSynth`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, print progress and let downstream utilities be chatty.</span>
<span class="sd">            Default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Output</span>
<span class="sd">        ------</span>
<span class="sd">        ``bathymetries/{ModelName}/bathymetry_{key}_wBasins.nc`` files containing:</span>
<span class="sd">        - LOSCAR-compatible bin edges (km),</span>
<span class="sd">        - global depth distribution (% per bin),</span>
<span class="sd">        - AOC, VOC, basin/HL area fractions (fanoc), basin volume fractions (fdvol),</span>
<span class="sd">        - and any auxiliary metadata written by ``BasinsSynth``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the directory to store synthetic bathymetry models within</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_file_structure</span><span class="p">([</span><span class="s2">&quot;/bathymetries/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelName</span><span class="p">)],</span> <span class="n">root</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

        <span class="c1"># Iterate over changes in deep and shallow bathymetry distributions</span>
        <span class="k">for</span> <span class="n">areaFactori</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AOC_factor</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
            <span class="n">areaFactori</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">areaFactori</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
            <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">7</span><span class="p">):</span>
                <span class="c1"># Iterates over binEdges at which gaussian distributed bathymetry is maximum.</span>
                <span class="c1">#   I.e., we create bathymetry models with seafloor at depths defined in the binEdges.</span>

                <span class="n">modeliString</span> <span class="o">=</span> <span class="s1">&#39;aF</span><span class="si">{}</span><span class="s1">_U</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">1e2</span><span class="o">*</span><span class="n">areaFactori</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">][</span><span class="n">bin_idx</span><span class="p">])));</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;VOC&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;AOC&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;fanoc&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;hb10&#39;</span><span class="p">]</span>


                <span class="c1"># Create object to hold bathymery components for a single synthetic bathymetry model.</span>
                <span class="n">BasinSynthi</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">BasinsSynth</span><span class="p">(</span><span class="n">dataDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/bathymetries/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelName</span><span class="p">),</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;bathymetry_</span><span class="si">{}</span><span class="s1">_wBasins.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modeliString</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mf">6371e3</span><span class="p">)</span>

                <span class="c1"># Set bathymetry distributions for basins</span>
                <span class="n">BasinSynthi</span><span class="o">.</span><span class="n">defineBasinParameters</span><span class="p">(</span>
                    <span class="n">BasinCnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="n">Distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e2</span><span class="p">,</span>
                    <span class="n">binEdges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSCARValues</span><span class="p">[</span><span class="s1">&#39;binEdges&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span>
                    <span class="n">AOC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;AOC&#39;</span><span class="p">],</span>
                    <span class="n">VOC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;VOC&#39;</span><span class="p">],</span>
                    <span class="n">fanoc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;fanoc&#39;</span><span class="p">],</span>
                    <span class="n">fdvol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BathymetryParms</span><span class="p">[</span><span class="n">modeliString</span><span class="p">][</span><span class="s1">&#39;fdvol&#39;</span><span class="p">],</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
                
                <span class="c1"># Set basin connectivity parameters</span>
                <span class="c1"># FIXME: Add for future analysis</span>
                <span class="c1">#BasinSynthi.defineBasinConnectivityParameters()</span>

                <span class="c1"># Write bathymetry distributions to netCDF4s</span>
                <span class="n">BasinSynthi</span><span class="o">.</span><span class="n">saveCcycleParameter</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>
</div>

                

<span class="c1">#######################################################################</span>
<span class="c1">############# ExoCcycle Calculate Ccycle Bathymetry Params ############</span>
<span class="c1">#######################################################################</span>
<span class="c1"># Define some methods to calculate bathymetry attributes from </span>
<div class="viewcode-block" id="calculateHighLatA">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.calculateHighLatA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculateHighLatA</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">highlatP</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the latitude cutoff that yields a target fraction of high-latitude ocean area,</span>
<span class="sd">    and return both the cutoff and the corresponding area.</span>

<span class="sd">    The routine treats the two hemispheres symmetrically. Starting from the poles</span>
<span class="sd">    (±90°), it steps the absolute-latitude cutoff equatorward in 0.1° increments</span>
<span class="sd">    until the cumulative ocean area poleward of that cutoff reaches or exceeds</span>
<span class="sd">    ``highlatP`` of the total ocean area (AOC). Ocean is defined where</span>
<span class="sd">    ``bathymetry &gt; 0`` (m), land/undefined where values are 0 or NaN.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bathymetry : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of seafloor depths in meters. Positive values denote</span>
<span class="sd">        ocean; 0 or NaN are treated as non-ocean and excluded from area totals.</span>
<span class="sd">    latitudes : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of cell-center latitudes in degrees, spanning [-90, 90],</span>
<span class="sd">        aligned with ``bathymetry``.</span>
<span class="sd">    areaWeights : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of cell areas in m² (or latitude-only weights broadcast</span>
<span class="sd">        to 2-D). Sum over all cells should approximate ``4πR²`` for the planet at</span>
<span class="sd">        the grid resolution used.</span>
<span class="sd">    highlatP : float</span>
<span class="sd">        Target fraction of *ocean* surface to include in the high-latitude box</span>
<span class="sd">        (decimal in [0, 1]). For example, ``0.10`` requests ~10% of total ocean area.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        If True, print the requested fraction, the resulting cutoff latitude,</span>
<span class="sd">        and the computed high-latitude area. Default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    highlatlat : float</span>
<span class="sd">        The absolute latitude (degrees, 0–90) that defines the high-latitude box:</span>
<span class="sd">        cells with ``|lat| &gt; highlatlat`` are counted as high-latitude ocean.</span>
<span class="sd">    highlatA : float</span>
<span class="sd">        Total high-latitude ocean area in m² using that cutoff.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * Total ocean area (AOC) is computed as the sum of ``areaWeights`` over</span>
<span class="sd">      cells where ``bathymetry &gt; 0`` (and not NaN).</span>
<span class="sd">    * The search decreases the cutoff from 90° toward 0° in steps of 0.1° until</span>
<span class="sd">      the poleward ocean-area fraction reaches ``highlatP``; the first cutoff</span>
<span class="sd">      meeting/exceeding the target is returned.</span>
<span class="sd">    * If ``highlatP &gt; 1``, a message is printed and the function returns ``None``.</span>
<span class="sd">      Consider validating inputs upstream if you need stricter error handling.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; highlatlat, highlatA = calculateHighLatA(bathy, lat, weights, highlatP=0.10)</span>
<span class="sd">    &gt;&gt;&gt; highlatlat</span>
<span class="sd">    63.4</span>
<span class="sd">    &gt;&gt;&gt; highlatA / np.nansum(weights[bathy &gt; 0])</span>
<span class="sd">    0.1003  # ~10% of ocean area</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    calculateBathymetryDistributionGlobal : Compute depth-binned global bathymetry distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the total seafloor area (AOC)</span>
    <span class="n">AOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span> <span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span> <span class="p">));</span>

    <span class="c1"># Check that high latitude box is at most 100 % of the ocean</span>
    <span class="k">if</span> <span class="n">highlatP</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The high latitude box was defined to be too large (i.e., it is greater than the size of the ocean). Change self.highlatP.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Iterate until percentArea reaches at least the size of the </span>
    <span class="c1"># high latitude box in precent area, self.highlatP.</span>
    <span class="n">highlatlat</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
    <span class="n">percentArea</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">percentArea</span> <span class="o">&lt;</span> <span class="n">highlatP</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">highlatlat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">highlatlat</span> <span class="o">-=</span> <span class="mf">.1</span><span class="p">;</span>
        <span class="n">percentArea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span> <span class="n">areaWeights</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)</span><span class="o">&gt;</span><span class="n">highlatlat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">==</span><span class="mi">0</span><span class="p">)]))</span><span class="o">/</span><span class="n">AOC</span><span class="p">;</span>

    <span class="c1"># Define bathymetry parameter</span>
    <span class="n">highlatA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">areaWeights</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)</span><span class="o">&gt;</span><span class="n">highlatlat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span> <span class="p">));</span>

    <span class="c1"># Report</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The input high latitude area should cover </span><span class="si">{:2.0f}% o</span><span class="s2">f seafloor area.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">highlatP</span><span class="p">));</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The high latitude cutoff is </span><span class="si">{:2.1f}</span><span class="s2"> degrees.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">highlatlat</span><span class="p">));</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The high latitude area is </span><span class="si">{:2.0f}</span><span class="s2"> m2.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">highlatA</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">highlatlat</span><span class="p">,</span> <span class="n">highlatA</span></div>



<div class="viewcode-block" id="calculateBathymetryDistributionGlobal">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.calculateBathymetryDistributionGlobal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculateBathymetryDistributionGlobal</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">highlatlat</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span>
                                          <span class="n">binEdges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute global depth-binned bathymetry area distributions (with and without</span>
<span class="sd">    high-latitude ocean), weighted by cell area.</span>

<span class="sd">    The routine forms two histograms of ocean depth (km):</span>
<span class="sd">    1) Including all ocean cells (global, pole-to-pole).</span>
<span class="sd">    2) Excluding high-latitude ocean, i.e., using only cells with</span>
<span class="sd">       ``|lat| &lt;= highlatlat`` (degrees).</span>

<span class="sd">    Both histograms are weighted by ``areaWeights`` and normalized to sum to 100%</span>
<span class="sd">    (percent of ocean area). Land/undefined cells are ignored.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bathymetry : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of seafloor depths in meters. Positive values denote</span>
<span class="sd">        ocean; 0 or NaN are treated as non-ocean and excluded.</span>
<span class="sd">    latitudes : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of cell-center latitudes in degrees, spanning [-90, 90],</span>
<span class="sd">        aligned with ``bathymetry``.</span>
<span class="sd">    highlatlat : float</span>
<span class="sd">        Absolute-latitude cutoff in degrees. Cells with ``|lat| &gt; highlatlat`` are</span>
<span class="sd">        considered “high-latitude” and are excluded from the low-latitude</span>
<span class="sd">        distribution.</span>
<span class="sd">    areaWeights : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of cell areas in m² (or latitude-only weights broadcast</span>
<span class="sd">        to 2-D). Values are used as histogram weights.</span>
<span class="sd">    binEdges : numpy.ndarray, optional</span>
<span class="sd">        1-D array of bin edges in kilometers used for depth binning. Anything deeper</span>
<span class="sd">        than the last edge falls into the last bin. Default is::</span>
<span class="sd">            np.array([0, 0.1, 0.6, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6.5])</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        If True, plots side-by-side bar charts (all ocean vs. no-high-lat).</span>
<span class="sd">        Default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bathymetryAreaDist : numpy.ndarray</span>
<span class="sd">        Percent area per depth bin **excluding** high-latitude ocean</span>
<span class="sd">        (i.e., using cells with ``|lat| &lt;= highlatlat``). Sums to ~100.</span>
<span class="sd">    bathymetryAreaDist_wHighlat : numpy.ndarray</span>
<span class="sd">        Percent area per depth bin **including** all ocean (global). Sums to ~100.</span>
<span class="sd">    binEdges : numpy.ndarray</span>
<span class="sd">        The bin edges used (km).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * Depths are converted from meters to kilometers before binning.</span>
<span class="sd">    * Each histogram uses normalized weights:</span>
<span class="sd">      ``weights = areaWeights[mask] / sum(areaWeights[mask])``, then scaled</span>
<span class="sd">      to percentages (×100).</span>
<span class="sd">    * Ensure that ``bathymetry`` has positive values over ocean; zeros/NaNs are</span>
<span class="sd">      excluded from the statistics.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; bins_km = np.array([0, 1, 2, 3, 4, 5, 6.5])</span>
<span class="sd">    &gt;&gt;&gt; dist_lowlat, dist_global, used_bins = calculateBathymetryDistributionGlobal(</span>
<span class="sd">    ...     bathy_m, lat_deg, highlatlat=60.0, areaWeights=cell_area_m2,</span>
<span class="sd">    ...     binEdges=bins_km, verbose=False)</span>
<span class="sd">    &gt;&gt;&gt; dist_lowlat.sum(), dist_global.sum()</span>
<span class="sd">    (100.0, 100.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set bins default array.</span>
    <span class="k">if</span> <span class="n">binEdges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]);</span>

    <span class="c1"># Calculate bathymetry distribution of global bathymetry (including high</span>
    <span class="c1"># latitude areas).</span>
    <span class="n">logical1</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
    <span class="n">bathy1</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">logical1</span><span class="p">];</span>
    <span class="n">weights1</span> <span class="o">=</span> <span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span><span class="p">]);</span>

    <span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">bathy1</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binEdges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights1</span><span class="p">);</span>
    <span class="n">bathymetryAreaDist_wHighlat</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">));</span>

    <span class="c1"># Calculate bathymetry distribution of global bathymetry (excluding high</span>
    <span class="c1"># latitude areas).</span>
    <span class="n">logical2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">highlatlat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
    <span class="n">bathy2</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">logical2</span><span class="p">];</span>
    <span class="n">weights2</span> <span class="o">=</span> <span class="n">areaWeights</span><span class="p">[</span><span class="n">logical2</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical2</span><span class="p">]);</span>

    <span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">bathy2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binEdges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights2</span><span class="p">);</span>
    <span class="n">bathymetryAreaDist</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">bathymetryAreaDist</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bathymetryAreaDist</span><span class="p">));</span>

    <span class="c1"># Report</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># print(&quot;Bin edges used:\n&quot;, binEdges)</span>
        <span class="c1"># print(&quot;Bathymetry area distribution including high latitude bathymetry:\n&quot;,bathymetryAreaDist_wHighlat);</span>
        <span class="c1"># print(&quot;Bathymetry area distribution excluding high latitude bathymetry:\n&quot;,bathymetryAreaDist);</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">factor1</span> <span class="o">=</span> <span class="mf">.2</span>
        <span class="n">factor2</span> <span class="o">=</span> <span class="mf">.25</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="p">(</span><span class="n">factor2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                <span class="n">height</span><span class="o">=</span><span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="n">factor1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                <span class="n">label</span><span class="o">=</span> <span class="s2">&quot;All bathymetry&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="p">(</span><span class="n">factor2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                <span class="n">height</span><span class="o">=</span><span class="n">bathymetryAreaDist</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="n">factor1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                <span class="n">label</span><span class="o">=</span> <span class="s2">&quot;Removed high latitude bathymetry: </span><span class="si">{:2.1f}</span><span class="s2"> degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">highlatlat</span><span class="p">))</span>
        <span class="c1"># ticks</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>

        <span class="c1"># Labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Planet&#39;s Bathymetry Distribution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bathymetry Bins [km]&quot;</span><span class="p">);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Seafloor Area [%]&quot;</span><span class="p">);</span>

        <span class="c1"># figure format</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="n">bathymetryAreaDist_wHighlat</span><span class="p">,</span> <span class="n">binEdges</span></div>



<div class="viewcode-block" id="calculateBathymetryDistributionBasin">
<a class="viewcode-back" href="../../apidoc/ExoCcycle.html#ExoCcycle.Bathymetry.calculateBathymetryDistributionBasin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculateBathymetryDistributionBasin</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">longitudes</span><span class="p">,</span> <span class="n">basinIDA</span><span class="p">,</span>
                                         <span class="n">highlatlat</span><span class="p">,</span> <span class="n">areaWeights</span><span class="p">,</span> <span class="n">binEdges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">fldName</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute per-basin bathymetry area and volume distributions, excluding and</span>
<span class="sd">    including high-latitude ocean, with global reference histograms.</span>

<span class="sd">    The function iterates over all unique basin IDs in ``basinIDA`` to calculate:</span>
<span class="sd">      * area-weighted depth distributions (% per bin),</span>
<span class="sd">      * fractional basin area (with/without high-lat region),</span>
<span class="sd">      * fractional basin volume (relative to total non-high-lat volume),</span>
<span class="sd">      * and global aggregate distributions for comparison.</span>

<span class="sd">    Optionally, when ``verbose=True``, it generates and saves:</span>
<span class="sd">      * a global basin map (Mollweide projection) and</span>
<span class="sd">      * a stacked bar plot of basin bathymetry distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bathymetry : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of seafloor depth values in meters. Positive depths</span>
<span class="sd">        represent ocean; zeros or NaNs are treated as land or undefined.</span>
<span class="sd">    latitudes : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of cell-center latitudes in degrees, ranging [-90, 90],</span>
<span class="sd">        aligned with ``bathymetry``.</span>
<span class="sd">    longitudes : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of cell-center longitudes in degrees, ranging [-180, 180],</span>
<span class="sd">        aligned with ``bathymetry``.</span>
<span class="sd">    basinIDA : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of integer basin identifiers. NaNs indicate unclassified</span>
<span class="sd">        or land cells.</span>
<span class="sd">    highlatlat : float</span>
<span class="sd">        Absolute-latitude cutoff (degrees) separating low-latitude ocean</span>
<span class="sd">        (|lat| ≤ highlatlat) from the high-latitude region.</span>
<span class="sd">    areaWeights : numpy.ndarray</span>
<span class="sd">        2-D array (ny, nx) of cell surface areas in m². The sum over all valid</span>
<span class="sd">        ocean cells should approximate ``4πR²`` for the Earth (or the model sphere).</span>
<span class="sd">    binEdges : numpy.ndarray, optional</span>
<span class="sd">        1-D array of depth bin edges in kilometers. Anything deeper than the last</span>
<span class="sd">        edge falls into the last bin. Default::</span>
<span class="sd">            np.array([0, 0.1, 0.6, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6.5])</span>
<span class="sd">    fldName : str, optional</span>
<span class="sd">        Directory path for figure output when ``verbose=True``. Default: current working directory.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        If True, print basin counts and generate basin map and histogram figures</span>
<span class="sd">        saved as ``Basin_Distributions.png`` and ``.svg`` in ``fldName``. Default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bathymetryAreaDist : dict[str, np.ndarray]</span>
<span class="sd">        Per-basin depth distributions (% area per bin) **excluding** high-latitude</span>
<span class="sd">        regions. Keys are &#39;Basin0&#39;, &#39;Basin1&#39;, etc.</span>
<span class="sd">    bathymetryVolFrac : dict[str, float]</span>
<span class="sd">        Fractional basin volume (decimal) normalized to the sum of all</span>
<span class="sd">        **non-high-latitude** ocean volumes.</span>
<span class="sd">    bathymetryAreaFrac : dict[str, float]</span>
<span class="sd">        Fractional basin area (decimal) excluding the high-lat region, normalized</span>
<span class="sd">        to total ocean area (including high-lat).</span>
<span class="sd">    bathymetryAreaFracG : dict[str, float]</span>
<span class="sd">        Fractional basin area (decimal) including all ocean area (high-lat included),</span>
<span class="sd">        normalized to total seafloor area.</span>
<span class="sd">    bathymetryAreaDist_wHighlatG : np.ndarray</span>
<span class="sd">        Global bathymetry distribution (% area per bin) **including** high-latitude</span>
<span class="sd">        ocean (pole-to-pole).</span>
<span class="sd">    bathymetryAreaDistG : np.ndarray</span>
<span class="sd">        Global bathymetry distribution (% area per bin) **excluding** high-latitude</span>
<span class="sd">        ocean (|lat| ≤ highlatlat).</span>
<span class="sd">    binEdges : np.ndarray</span>
<span class="sd">        Bin edges (km) used for all histograms.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * Depths are converted from meters to kilometers prior to binning.</span>
<span class="sd">    * Basin-wise histograms are normalized such that each sums to 100% area within</span>
<span class="sd">      its respective basin domain.</span>
<span class="sd">    * Area and volume fractions are normalized to global totals using ``areaWeights``.</span>
<span class="sd">    * Basin IDs are taken as unique non-NaN entries in ``basinIDA``; their order</span>
<span class="sd">      corresponds to sorted unique IDs.</span>
<span class="sd">    * The resulting basin-level distributions can be used directly as LOSCAR</span>
<span class="sd">      bathymetry inputs.</span>

<span class="sd">    Visualization</span>
<span class="sd">    -------------</span>
<span class="sd">    When ``verbose=True``, this routine:</span>
<span class="sd">      - Creates a Mollweide map of basin partitions over ``longitudes``/``latitudes``.</span>
<span class="sd">      - Plots bathymetry distributions per basin (stacked bar chart) with labeled bins.</span>
<span class="sd">      - Saves both figures to ``fldName/Basin_Distributions.{png,svg}``.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; dist, volFrac, areaFrac, areaFracG, distGH, distG, bins = calculateBathymetryDistributionBasin(</span>
<span class="sd">    ...     bathy, lat, lon, basinID, highlatlat=60, areaWeights=weights, verbose=False)</span>
<span class="sd">    &gt;&gt;&gt; list(dist.keys())</span>
<span class="sd">    [&#39;Basin0&#39;, &#39;Basin1&#39;, &#39;Basin2&#39;]</span>
<span class="sd">    &gt;&gt;&gt; np.sum(list(volFrac.values()))</span>
<span class="sd">    1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set bins default array.</span>
    <span class="k">if</span> <span class="n">binEdges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]);</span>
    
    <span class="c1"># Setup dictionaries to hold outputs (basin distributions, area fractions, and volume fractions)</span>
    <span class="n">bathymetryAreaDist</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">bathymetryAreaFrac</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">bathymetryAreaFracG</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">bathymetryVolFrac</span>  <span class="o">=</span> <span class="p">{};</span>
    
    <span class="n">basinIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">basinIDA</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">basinIDA</span><span class="p">)]);</span>

    <span class="c1"># Iterate over basins</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinIDs</span><span class="p">)):</span>
        <span class="c1"># Set basin ID and define basin i only bathymetry</span>
        <span class="n">basinIDi</span> <span class="o">=</span> <span class="n">basinIDs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        
        <span class="c1"># Calculate bathymetry distribution of basin bathymetry (excluding high</span>
        <span class="c1"># latitude areas).</span>
        <span class="c1"># High latitude constraint</span>
        <span class="n">logical1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">highlatlat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
        <span class="n">logical2</span> <span class="o">=</span> <span class="p">(</span><span class="n">basinIDA</span><span class="o">==</span><span class="n">basinIDi</span><span class="p">);</span>
        <span class="n">bathy2</span>   <span class="o">=</span> <span class="n">bathymetry</span><span class="p">[</span><span class="n">logical1</span> <span class="o">&amp;</span> <span class="n">logical2</span><span class="p">];</span>
        <span class="n">weights2</span> <span class="o">=</span> <span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span> <span class="o">&amp;</span> <span class="n">logical2</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span> <span class="o">&amp;</span> <span class="n">logical2</span><span class="p">]);</span>

        <span class="n">bathymetryAreaDisti</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathy2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binEdges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights2</span><span class="p">);</span>
        <span class="n">bathymetryAreaDist</span><span class="p">[</span><span class="s1">&#39;Basin</span><span class="si">{:0.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basinIDi</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">bathymetryAreaDisti</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bathymetryAreaDisti</span><span class="p">));</span>
        <span class="n">bathymetryAreaFracG</span><span class="p">[</span><span class="s1">&#39;Basin</span><span class="si">{:0.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basinIDi</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical2</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span>
        <span class="n">bathymetryAreaFrac</span><span class="p">[</span><span class="s1">&#39;Basin</span><span class="si">{:0.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basinIDi</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span> <span class="o">&amp;</span> <span class="n">logical2</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span>
        <span class="n">bathymetryVolFrac</span><span class="p">[</span><span class="s1">&#39;Basin</span><span class="si">{:0.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basinIDi</span><span class="p">)]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">logical1</span> <span class="o">&amp;</span> <span class="n">logical2</span><span class="p">]</span><span class="o">*</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span> <span class="o">&amp;</span> <span class="n">logical2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">logical1</span><span class="p">]</span><span class="o">*</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span><span class="p">]);</span>

    <span class="c1"># Calculate Global values</span>
    <span class="c1">## Calculate bathymetry distribution of global bathymetry (including high</span>
    <span class="c1">## latitude areas).</span>
    <span class="n">logical1</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
    <span class="n">bathy1</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathymetry</span><span class="p">[</span><span class="n">logical1</span><span class="p">];</span>
    <span class="n">weights1</span> <span class="o">=</span> <span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical1</span><span class="p">]);</span>

    <span class="n">bathymetryAreaDist_wHighlatG</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">bathy1</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binEdges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights1</span><span class="p">);</span>
    <span class="n">bathymetryAreaDist_wHighlatG</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">bathymetryAreaDist_wHighlatG</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bathymetryAreaDist_wHighlatG</span><span class="p">));</span>

    <span class="c1">## Calculate bathymetry distribution of global bathymetry (excluding high</span>
    <span class="c1">## latitude areas).</span>
    <span class="n">logical2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">latitudes</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">highlatlat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">);</span>
    <span class="n">bathy2</span>   <span class="o">=</span> <span class="n">bathymetry</span><span class="p">[</span><span class="n">logical2</span><span class="p">];</span>
    <span class="n">weights2</span> <span class="o">=</span> <span class="n">areaWeights</span><span class="p">[</span><span class="n">logical2</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areaWeights</span><span class="p">[</span><span class="n">logical2</span><span class="p">]);</span>

    <span class="n">bathymetryAreaDistG</span><span class="p">,</span> <span class="n">binEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">((</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">bathy2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binEdges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights2</span><span class="p">);</span>
    <span class="n">bathymetryAreaDistG</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">bathymetryAreaDistG</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bathymetryAreaDistG</span><span class="p">));</span>

    <span class="c1"># Report</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># print(&quot;Bin edges used:\n&quot;, binEdges);</span>
        <span class="c1"># print(&quot;Bathymetry area distribution excluding high latitude bathymetry:\n&quot;);</span>
        <span class="c1"># for basinIDi in range(len(bathymetryAreaDist)):</span>
        <span class="c1">#     print(bathymetryAreaDist[&#39;Basin{:0.0f}&#39;.format(basinIDi)]);</span>

        <span class="c1">#fig = plt.figure(figsize=(8,4))</span>

        <span class="c1"># Define the number of basins</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bathymetryAreaDist</span><span class="p">);</span>

        <span class="c1"># Create colormap</span>
        <span class="c1">## Set colormap</span>
        <span class="c1">#cmap = plt.get_cmap(&quot;Pastel1&quot;)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;Set1&quot;</span><span class="p">)</span>

        <span class="c1">## Extract basinCnt colors from the colormap</span>
        <span class="n">colors_rgb</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cnt</span><span class="p">)]</span>
        <span class="c1">## Convert RGB to hex</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="mi">255</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">colors_rgb</span><span class="p">]</span>
        <span class="c1">## Create a custom colormap from the list of colors</span>
        <span class="n">custom_cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;custom_pastel&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

        <span class="c1"># Set up the Mollweide projection</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>  <span class="c1"># 2 rows, 1 column, with both row heights equal.</span>

        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Mollweide</span><span class="p">());</span>

        <span class="c1"># Plot basin contourf and coastlines</span>

        <span class="c1">## Add the plot using pcolormesh</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">basinIDA</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">custom_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

        <span class="c1">## Add coastlines</span>
        <span class="c1">### Set any np.nan values to 0.</span>
        <span class="n">bathymetry</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathymetry</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="c1">### Plot coastlines.</span>
        <span class="n">zeroContour</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">bathymetry</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>


        <span class="c1"># Make bathymetry distribution plot</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="c1">## Define factors for plotting</span>
        <span class="n">factor1</span> <span class="o">=</span> <span class="mf">.1</span>
        <span class="n">factor2</span> <span class="o">=</span> <span class="mf">.25</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bathymetryAreaDist</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">factor3</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        
        <span class="c1">## Iteratively plot basin bathymetry distributions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bathymetryAreaDist</span><span class="p">)):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="p">(</span><span class="n">factor2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">cnt</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span><span class="n">factor3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">bathymetryAreaDist</span><span class="p">[</span><span class="s1">&#39;Basin</span><span class="si">{:0.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">factor1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">binEdges</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span> <span class="s2">&quot;Basin </span><span class="si">{:0.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1">## ticks</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">binEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>

        <span class="c1">## Labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Planet&#39;s Bathymetry Distribution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bathymetry Bins [km]&quot;</span><span class="p">);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Seafloor Area [%]&quot;</span><span class="p">);</span>

        <span class="c1">## figure format</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fldName</span><span class="o">+</span><span class="s2">&quot;/Basin_Distributions.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fldName</span><span class="o">+</span><span class="s2">&quot;/Basin_Distributions.svg&quot;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bathymetryAreaDist</span><span class="p">,</span> <span class="n">bathymetryVolFrac</span><span class="p">,</span> <span class="n">bathymetryAreaFrac</span><span class="p">,</span> <span class="n">bathymetryAreaFracG</span><span class="p">,</span> <span class="n">bathymetryAreaDist_wHighlatG</span><span class="p">,</span> <span class="n">bathymetryAreaDistG</span><span class="p">,</span> <span class="n">binEdges</span></div>


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ExoCcycle</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/modules.html">ExoCcycle</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, ExoCcycle authors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>